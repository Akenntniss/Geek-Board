<?php
// Vérifier si l'ID de la réparation est fourni
if (!isset($_GET['id']) || empty($_GET['id'])) {
    set_message("ID réparation non spécifié.", "danger");
    redirect("reparations");
}

// Fonction pour convertir une couleur hexadécimale en RGB
function hexToRgb($hex) {
    // Supprimer le # si présent
    $hex = ltrim($hex, '#');
    
    // Convertir en RGB
    if(strlen($hex) == 3) {
        $r = hexdec(substr($hex, 0, 1).substr($hex, 0, 1));
        $g = hexdec(substr($hex, 1, 1).substr($hex, 1, 1));
        $b = hexdec(substr($hex, 2, 1).substr($hex, 2, 1));
    } else {
        $r = hexdec(substr($hex, 0, 2));
        $g = hexdec(substr($hex, 2, 2));
        $b = hexdec(substr($hex, 4, 2));
    }
    
    return "$r, $g, $b";
}

$reparation_id = (int)$_GET['id'];

// Récupérer les informations de la réparation
try {
    $stmt = $pdo->prepare("
        SELECT r.*, c.nom as client_nom, c.prenom as client_prenom, c.telephone as client_telephone
        FROM reparations r
        JOIN clients c ON r.client_id = c.id
        WHERE r.id = ?
    ");
    $stmt->execute([$reparation_id]);
    $reparation = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$reparation) {
        set_message("Réparation non trouvée.", "danger");
        redirect("reparations");
    }
} catch (PDOException $e) {
    set_message("Erreur lors de la récupération des informations de la réparation: " . $e->getMessage(), "danger");
    redirect("reparations");
}

// Vérifier si l'utilisateur est déjà attribué à cette réparation
$user_id = $_SESSION['user_id'];
$est_attribue = false;
$attribution_id = null;

try {
    // Vérifier dans la table reparation_attributions
    $stmt = $pdo->prepare("
        SELECT ra.id 
        FROM reparation_attributions ra
        WHERE ra.reparation_id = ? AND ra.employe_id = ? AND ra.date_fin IS NULL
    ");
    $stmt->execute([$reparation_id, $user_id]);
    $attribution = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if ($attribution) {
        $est_attribue = true;
        $attribution_id = $attribution['id'];
    }
    
    // Vérifier aussi dans la table users (si active_repair_id = reparation_id et techbusy = 1)
    if (!$est_attribue) {
        $stmt = $pdo->prepare("
            SELECT id FROM users 
            WHERE id = ? AND active_repair_id = ? AND techbusy = 1
        ");
        $stmt->execute([$user_id, $reparation_id]);
        
        if ($stmt->rowCount() > 0) {
            $est_attribue = true;
        }
    }
    
    // Afficher le statut d'attribution dans la console pour débogage
    echo "<!-- Statut d'attribution: " . ($est_attribue ? 'Attribué' : 'Non attribué') . " -->";
    
} catch (PDOException $e) {
    // Erreur silencieuse, on considère que l'utilisateur n'est pas attribué
    error_log("Erreur lors de la vérification de l'attribution: " . $e->getMessage());
}

// Traitement de la mise à jour des notes techniques
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'update_notes') {
    $notes_techniques = clean_input($_POST['notes_techniques'] ?? '');
    
    try {
        // Mettre à jour les notes techniques
        $stmt = $pdo->prepare("UPDATE reparations SET notes_techniques = ? WHERE id = ?");
        $stmt->execute([$notes_techniques, $reparation_id]);
        
        // Enregistrer l'action dans les logs
        $stmt = $pdo->prepare("
            INSERT INTO reparation_logs 
            (reparation_id, employe_id, action_type, details) 
            VALUES (?, ?, ?, ?)
        ");
        $stmt->execute([
            $reparation_id,
            $_SESSION['user_id'],
            'mise_a_jour_notes',
            'Mise à jour des notes techniques'
        ]);
        
        set_message("Notes techniques mises à jour avec succès!", "success");
        redirect("index.php?page=statut_rapide&id=" . $reparation_id);
        
    } catch (PDOException $e) {
        set_message("Erreur lors de la mise à jour des notes techniques: " . $e->getMessage(), "danger");
    }
}

// Traitement de la mise à jour du statut
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['nouveau_statut'])) {
    $nouveau_statut = clean_input($_POST['nouveau_statut']);
    $statut_id = isset($_POST['statut_id']) ? (int)$_POST['statut_id'] : 0;
    $statut_categorie = isset($_POST['categorie_id']) ? (int)$_POST['categorie_id'] : 0;
    
    try {
        // Récupérer l'ancien statut pour le log
        $stmt = $pdo->prepare("SELECT statut FROM reparations WHERE id = ?");
        $stmt->execute([$reparation_id]);
        $ancien_statut = $stmt->fetchColumn();
        
        // Mise à jour du statut de la réparation
        $stmt = $pdo->prepare("UPDATE reparations SET statut = ?, statut_categorie = ?, date_modification = NOW() WHERE id = ?");
        $stmt->execute([$nouveau_statut, $statut_categorie, $reparation_id]);
        
        // Enregistrer le changement dans les logs
        $stmt = $pdo->prepare("
            INSERT INTO reparation_logs 
            (reparation_id, employe_id, action_type, statut_avant, statut_apres, details) 
            VALUES (?, ?, ?, ?, ?, ?)
        ");
        $stmt->execute([
            $reparation_id,
            $user_id,
            'changement_statut',
            $ancien_statut,
            $nouveau_statut,
            'Mise à jour via Statut Rapide'
        ]);
        
        // NOUVEAU: Envoi de SMS automatique
        $sms_sent = false;
        $sms_message = '';
        
        // Vérifier s'il existe un modèle de SMS pour ce statut
        if ($statut_id > 0) {
            $stmt = $pdo->prepare("
                SELECT id, nom, contenu 
                FROM sms_templates 
                WHERE statut_id = ? AND est_actif = 1
            ");
            $stmt->execute([$statut_id]);
            $template = $stmt->fetch(PDO::FETCH_ASSOC);
            
            if ($template && !empty($reparation['client_telephone'])) {
                // Préparer le contenu du SMS en remplaçant les variables
                $message = $template['contenu'];
                
                // Créer un fichier de log dans un dossier accessible
                $log_dir = dirname(__DIR__) . '/logs';
                if (!is_dir($log_dir)) {
                    mkdir($log_dir, 0755, true);
                }
                $log_file = $log_dir . '/sms_debug_' . date('Y-m-d') . '.log';
                
                // Fonction de log
                $log_debug = function($message) use ($log_file) {
                    file_put_contents($log_file, date('[Y-m-d H:i:s] ') . $message . "\n", FILE_APPEND);
                };
                
                // Logs avant remplacement
                $log_debug("====== DÉBUT DEBUG SMS ======");
                $log_debug("Template ID: " . $template['id']);
                $log_debug("Template nom: " . $template['nom']);
                $log_debug("Template contenu brut: " . $template['contenu']);
                $log_debug("Réparation ID: " . $reparation_id);
                
                // Tableau des remplacements
                $replacements = [
                    '[CLIENT_NOM]' => $reparation['client_nom'],
                    '[CLIENT_PRENOM]' => $reparation['client_prenom'],
                    '[CLIENT_TELEPHONE]' => $reparation['client_telephone'],
                    '[REPARATION_ID]' => $reparation_id,
                    '[APPAREIL_TYPE]' => $reparation['type_appareil'],
                    '[APPAREIL_MARQUE]' => $reparation['marque'],
                    '[APPAREIL_MODELE]' => $reparation['modele'],
                    '[DATE_RECEPTION]' => format_date($reparation['date_reception']),
                    '[DATE_FIN_PREVUE]' => format_date($reparation['date_fin_prevue'] ?? ''),
                    '[PRIX]' => !empty($reparation['prix_reparation']) ? number_format($reparation['prix_reparation'], 2, ',', ' ') : ''
                ];
                
                // Log des variables et leurs valeurs
                $log_debug("Variables à remplacer:");
                foreach ($replacements as $var => $value) {
                    $log_debug("  {$var} => " . (is_null($value) ? "NULL" : "'{$value}'"));
                }
                
                // Message avant remplacement
                $log_debug("Message avant remplacement: " . $message);
                
                // Effectuer les remplacements
                foreach ($replacements as $var => $value) {
                    // Log pour chaque remplacement
                    $old_message = $message;
                    $message = str_replace($var, $value, $message);
                    $log_debug("Remplacement de '{$var}' par '{$value}': " . ($old_message === $message ? "AUCUN CHANGEMENT" : "OK"));
                }
                
                // Correction spécifique pour le problème [CLIENT_NOM][CLIENT_PRENOM] sans espace
                if (strpos($message, '][') !== false) {
                    $log_debug("Détection de variables collées sans espace ']]['");
                    $old_message = $message;
                    $message = str_replace('][', '] [', $message);
                    $log_debug("Correction des variables collées: " . ($old_message === $message ? "AUCUN CHANGEMENT" : "OK - " . $message));
                }
                
                // Log du message final
                $log_debug("Message final après remplacement: " . $message);
                
                // Envoyer le SMS
                if (function_exists('send_sms')) {
                    $log_debug("Tentative d'envoi SMS à " . $reparation['client_telephone']);
                    $sms_result = send_sms($reparation['client_telephone'], $message);
                    $log_debug("Résultat de l'envoi: " . ($sms_result['success'] ? "SUCCÈS" : "ÉCHEC - " . ($sms_result['message'] ?? "Erreur inconnue")));
                    
                    if ($sms_result['success']) {
                        $sms_sent = true;
                        
                        // Enregistrer l'envoi du SMS dans la base de données
                        $stmt = $pdo->prepare("
                            INSERT INTO reparation_sms (reparation_id, template_id, telephone, message, date_envoi, statut_id)
                            VALUES (?, ?, ?, ?, NOW(), ?)
                        ");
                        $stmt->execute([
                            $reparation_id, 
                            $template['id'], 
                            $reparation['client_telephone'], 
                            $message, 
                            $statut_id
                        ]);
                        
                        $sms_message = 'Un SMS a été envoyé au client.';
                        set_message("Statut mis à jour avec succès! " . $sms_message, "success");
                    } else {
                        $sms_message = "Erreur lors de l'envoi du SMS: " . $sms_result['message'];
                        set_message("Statut mis à jour, mais " . $sms_message, "warning");
                    }
                } else {
                    $log_debug("ERREUR: La fonction send_sms n'existe pas!");
                    set_message("Statut mis à jour, mais la fonction d'envoi SMS n'est pas disponible.", "warning");
                }
                
                $log_debug("====== FIN DEBUG SMS ======");
            } else {
                if (empty($template)) {
                    set_message("Statut mis à jour. Aucun modèle SMS disponible pour ce statut.", "info");
                } else {
                    set_message("Statut mis à jour. Le client n'a pas de numéro de téléphone pour SMS.", "info");
                }
            }
        } else {
            set_message("Statut mis à jour avec succès.", "success");
        }
        
        // Rediriger pour éviter les soumissions multiples
        redirect("index.php?page=statut_rapide&id=" . $reparation_id);
        
        } catch (PDOException $e) {
        set_message("Erreur lors de la mise à jour du statut: " . $e->getMessage(), "danger");
    }
}

// Traitement du formulaire de finalisation
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action']) && $_POST['action'] === 'finaliser') {
    // Récupérer et nettoyer les données
    $statut_final = clean_input($_POST['statut_final'] ?? '');
    $notes_techniques = clean_input($_POST['notes_techniques'] ?? '');
    $envoi_sms = isset($_POST['envoi_sms']) && $_POST['envoi_sms'] === 'on';
    
    // Déterminer le statut_id en fonction du statut_final
    $statut_id = 0;
    switch ($statut_final) {
        case 'reparation_effectue':
            $statut_id = 9;
            break;
        case 'reparation_annule':
            $statut_id = 10;
            break;
        case 'restitue':
            $statut_id = 11;
            break;
        case 'en_attente_responsable':
            $statut_id = 8;
            break;
        default:
            $statut_id = 0;
    }
    
    // Vérifier si le statut est valide
    if (empty($statut_final) || !in_array($statut_final, ['reparation_effectue', 'reparation_annule', 'restitue', 'en_attente_responsable'])) {
        set_message("Vous devez sélectionner un statut valide pour finaliser la réparation.", "danger");
    } else {
        try {
            // Récupérer l'ancien statut
            $stmt = $pdo->prepare("SELECT statut FROM reparations WHERE id = ?");
            $stmt->execute([$reparation_id]);
            $ancien_statut = $stmt->fetchColumn();
            
            // Mettre à jour la réparation
            $stmt = $pdo->prepare("
                UPDATE reparations 
                SET statut = ?, statut_categorie = ?, notes_techniques = ?, date_modification = NOW()
                WHERE id = ?
            ");
            
            // Déterminer la catégorie de statut en fonction du statut
            $statut_categorie = 4; // Par défaut, terminé
            if ($statut_final === 'en_attente_responsable') {
                $statut_categorie = 3; // En attente
            }
            
            $stmt->execute([$statut_final, $statut_categorie, $notes_techniques, $reparation_id]);
            
            // Terminer toutes les attributions actives pour cette réparation
            $stmt = $pdo->prepare("
                UPDATE reparation_attributions 
                SET date_fin = NOW() 
                WHERE reparation_id = ? AND date_fin IS NULL
            ");
            $stmt->execute([$reparation_id]);
            
            // Libérer les techniciens associés
            $stmt = $pdo->prepare("
                UPDATE users 
                SET techbusy = 0, active_repair_id = NULL 
                WHERE active_repair_id = ?
            ");
            $stmt->execute([$reparation_id]);
            
            // Enregistrer dans les logs
            $stmt = $pdo->prepare("
                INSERT INTO reparation_logs 
                (reparation_id, employe_id, action_type, statut_avant, statut_apres, details) 
                VALUES (?, ?, ?, ?, ?, ?)
            ");
            
            $stmt->execute([
                $reparation_id,
                $_SESSION['user_id'],
                'terminer',
                $ancien_statut,
                $statut_final,
                $notes_techniques
            ]);
            
            // NOUVEAU: Envoyer un SMS si l'option est activée
            $sms_sent = false;
            $sms_message = '';
            
            if ($envoi_sms) {
                // Vérifier s'il existe un modèle de SMS pour ce statut
                $stmt = $pdo->prepare("
                    SELECT id, nom, contenu 
                    FROM sms_templates 
                    WHERE statut_id = ? AND est_actif = 1
                ");
                $stmt->execute([$statut_id]);
                $template = $stmt->fetch(PDO::FETCH_ASSOC);
                
                if ($template && !empty($reparation['client_telephone'])) {
                    // Préparer le contenu du SMS en remplaçant les variables
                    $message = $template['contenu'];
                    
                    // Créer un fichier de log dans un dossier accessible
                    $log_dir = dirname(__DIR__) . '/logs';
                    if (!is_dir($log_dir)) {
                        mkdir($log_dir, 0755, true);
                    }
                    $log_file = $log_dir . '/sms_debug_' . date('Y-m-d') . '.log';
                    
                    // Fonction de log
                    $log_debug = function($message) use ($log_file) {
                        file_put_contents($log_file, date('[Y-m-d H:i:s] ') . $message . "\n", FILE_APPEND);
                    };
                    
                    // Logs avant remplacement
                    $log_debug("====== DÉBUT DEBUG SMS ======");
                    $log_debug("Template ID: " . $template['id']);
                    $log_debug("Template nom: " . $template['nom']);
                    $log_debug("Template contenu brut: " . $template['contenu']);
                    $log_debug("Réparation ID: " . $reparation_id);
                    
                    // Tableau des remplacements
                    $replacements = [
                        '[CLIENT_NOM]' => $reparation['client_nom'],
                        '[CLIENT_PRENOM]' => $reparation['client_prenom'],
                        '[CLIENT_TELEPHONE]' => $reparation['client_telephone'],
                        '[REPARATION_ID]' => $reparation_id,
                        '[APPAREIL_TYPE]' => $reparation['type_appareil'],
                        '[APPAREIL_MARQUE]' => $reparation['marque'],
                        '[APPAREIL_MODELE]' => $reparation['modele'],
                        '[DATE_RECEPTION]' => format_date($reparation['date_reception']),
                        '[DATE_FIN_PREVUE]' => format_date($reparation['date_fin_prevue'] ?? ''),
                        '[PRIX]' => !empty($reparation['prix_reparation']) ? number_format($reparation['prix_reparation'], 2, ',', ' ') : ''
                    ];
                    
                    // Log des variables et leurs valeurs
                    $log_debug("Variables à remplacer:");
                    foreach ($replacements as $var => $value) {
                        $log_debug("  {$var} => " . (is_null($value) ? "NULL" : "'{$value}'"));
                    }
                    
                    // Message avant remplacement
                    $log_debug("Message avant remplacement: " . $message);
                    
                    // Effectuer les remplacements
                    foreach ($replacements as $var => $value) {
                        // Log pour chaque remplacement
                        $old_message = $message;
                        $message = str_replace($var, $value, $message);
                        $log_debug("Remplacement de '{$var}' par '{$value}': " . ($old_message === $message ? "AUCUN CHANGEMENT" : "OK"));
                    }
                    
                    // Correction spécifique pour le problème [CLIENT_NOM][CLIENT_PRENOM] sans espace
                    if (strpos($message, '][') !== false) {
                        $log_debug("Détection de variables collées sans espace ']]['");
                        $old_message = $message;
                        $message = str_replace('][', '] [', $message);
                        $log_debug("Correction des variables collées: " . ($old_message === $message ? "AUCUN CHANGEMENT" : "OK - " . $message));
                    }
                    
                    // Log du message final
                    $log_debug("Message final après remplacement: " . $message);
                    
                    // Envoyer le SMS
                    if (function_exists('send_sms')) {
                        $log_debug("Tentative d'envoi SMS à " . $reparation['client_telephone']);
                        $sms_result = send_sms($reparation['client_telephone'], $message);
                        $log_debug("Résultat de l'envoi: " . ($sms_result['success'] ? "SUCCÈS" : "ÉCHEC - " . ($sms_result['message'] ?? "Erreur inconnue")));
                        
                        if ($sms_result['success']) {
                            $sms_sent = true;
                            
                            // Enregistrer l'envoi du SMS dans la base de données
                            $stmt = $pdo->prepare("
                                INSERT INTO reparation_sms (reparation_id, template_id, telephone, message, date_envoi, statut_id)
                                VALUES (?, ?, ?, ?, NOW(), ?)
                            ");
                            $stmt->execute([
                                $reparation_id, 
                                $template['id'], 
                                $reparation['client_telephone'], 
                                $message, 
                                $statut_id
                            ]);
                            
                            $sms_message = 'Un SMS a été envoyé au client.';
                        } else {
                            $sms_message = "Erreur lors de l'envoi du SMS: " . $sms_result['message'];
                        }
                    } else {
                        $log_debug("ERREUR: La fonction send_sms n'existe pas!");
                        $sms_message = "La fonction d'envoi SMS n'est pas disponible.";
                    }
                    
                    $log_debug("====== FIN DEBUG SMS ======");
                } else {
                    if (empty($template)) {
                        $sms_message = "Aucun modèle SMS disponible pour ce statut.";
                    } else {
                        $sms_message = "Le client n'a pas de numéro de téléphone pour SMS.";
                    }
                }
            }
            
            // Message de confirmation
            if ($sms_sent) {
                set_message("La réparation a été finalisée avec succès! " . $sms_message, "success");
            } else if (!empty($sms_message) && $envoi_sms) {
                set_message("La réparation a été finalisée. " . $sms_message, "warning");
            } else {
                set_message("La réparation a été finalisée avec succès!", "success");
            }
            
            // Rediriger vers la liste des réparations
            redirect("reparations");
            
        } catch (PDOException $e) {
            set_message("Erreur lors de la finalisation de la réparation: " . $e->getMessage(), "danger");
        }
    }
}

// Récupérer tous les statuts par catégorie
try {
    $statuts_par_categorie = get_all_statuts();
} catch (Exception $e) {
    $statuts_par_categorie = [];
    set_message("Erreur lors de la récupération des statuts: " . $e->getMessage(), "danger");
}

// Récupérer les photos de la réparation
$photos = [];
try {
    $stmt = $pdo->prepare("SELECT * FROM photos_reparation WHERE reparation_id = ? ORDER BY date_upload DESC");
    $stmt->execute([$reparation_id]);
    $photos = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    // Gérer l'erreur silencieusement
    error_log("Erreur lors de la récupération des photos: " . $e->getMessage());
}

// Inclure le modal de finalisation
if ($est_attribue) {
    include_once(BASE_PATH . '/components/terminer_modal.php');
}
?>

<!-- Préchargeur futuriste -->
<div id="futuristic-preloader">
    <div class="preloader-container">
        <div class="scanner"></div>
        <div class="loading-text">CHARGEMENT</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>
</div>

<!-- Ajouter les meta tags pour gérer les zones de sécurité -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<style>
/* Styles du préchargeur futuriste */
#futuristic-preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: var(--bg-color, rgba(13, 17, 28, 0.95));
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.5s, visibility 0.5s;
}

.preloader-container {
    position: relative;
    width: 200px;
    height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.scanner {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 2px solid rgba(30, 144, 255, 0.3);
    position: relative;
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.scanner::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 5px;
    background: linear-gradient(90deg, transparent, rgba(30, 144, 255, 0.8), transparent);
    animation: scan 2s linear infinite;
    top: 50%;
    transform: translateY(-50%);
}

.scanner::after {
    content: '';
    position: absolute;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 2px solid rgba(30, 144, 255, 0.5);
    animation: pulse 1.5s infinite alternate;
}

@keyframes scan {
    0% { left: -100%; }
    100% { left: 100%; }
}

@keyframes pulse {
    0% { box-shadow: 0 0 10px rgba(30, 144, 255, 0.5), 0 0 20px rgba(30, 144, 255, 0.3) inset; transform: scale(0.95); }
    100% { box-shadow: 0 0 20px rgba(30, 144, 255, 0.8), 0 0 40px rgba(30, 144, 255, 0.5) inset; transform: scale(1.05); }
}

.loading-text {
    color: var(--accent-color, #1e90ff);
    font-family: 'Segoe UI', Roboto, Arial, sans-serif;
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 3px;
    margin-bottom: 15px;
    text-shadow: 0 0 10px var(--accent-glow, rgba(30, 144, 255, 0.7));
    animation: textGlow 1.5s infinite alternate;
}

@keyframes textGlow {
    0% { opacity: 0.7; text-shadow: 0 0 5px rgba(30, 144, 255, 0.5); }
    100% { opacity: 1; text-shadow: 0 0 15px rgba(30, 144, 255, 0.9); }
}

.loading-bar {
    width: 180px;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    position: relative;
}

.loading-progress {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, rgba(30, 144, 255, 0.7), rgba(0, 77, 155, 0.9));
    border-radius: 10px;
    animation: loadProgress 2.5s ease-in-out forwards;
}

@keyframes loadProgress {
    0% { width: 0%; }
    50% { width: 70%; }
    100% { width: 100%; }
}

/* Cache le préchargeur quand le chargement est terminé */
#futuristic-preloader.loaded {
    opacity: 0;
    visibility: hidden;
}

/* Styles pour l'interface futuriste */
body, html {
    height: 100%;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Roboto, Arial, sans-serif;
    overflow: hidden;
}

/* Ajustement pour les modes clair et sombre */
:root {
    --bg-color: rgba(255, 255, 255, 0.95);
    --header-bg: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(0, 77, 155, 0.2));
    --panel-bg: rgba(255, 255, 255, 0.9);
    --text-color: #1a1f36;
    --text-secondary: #4a5568;
    --border-color: rgba(30, 144, 255, 0.3);
    --accent-color: #1e90ff;
    --accent-glow: rgba(30, 144, 255, 0.4);
    --card-bg: rgba(255, 255, 255, 0.7);
    --input-bg: rgba(255, 255, 255, 0.05);
    --btn-gradient: linear-gradient(135deg, #1e90ff, #0066cc);
    --shadow: 0 8px 32px rgba(30, 144, 255, 0.3);
    --modal-bg: rgba(255, 255, 255, 0.95);
}

.dark-mode {
    --bg-color: rgba(13, 17, 28, 0.9);
    --header-bg: linear-gradient(135deg, rgba(30, 144, 255, 0.3), rgba(0, 77, 155, 0.3));
    --panel-bg: rgba(20, 25, 45, 0.8);
    --text-color: #e2e8f0;
    --text-secondary: #a0aec0;
    --border-color: rgba(30, 144, 255, 0.5);
    --accent-color: #60a5fa;
    --accent-glow: rgba(30, 144, 255, 0.6);
    --card-bg: rgba(30, 40, 60, 0.7);
    --input-bg: rgba(255, 255, 255, 0.05);
    --btn-gradient: linear-gradient(135deg, #3b82f6, #1e40af);
    --shadow: 0 8px 32px rgba(30, 144, 255, 0.5);
    --modal-bg: rgba(13, 17, 28, 0.95);
}

/* Styles généraux */
.mobile-interface {
    display: flex;
    flex-direction: column;
    height: 100vh;
    width: 100%;
    overflow: hidden;
    background: var(--bg-color);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
}

/* Classes pour gérer les zones de sécurité */
.safe-area-top {
    padding-top: env(safe-area-inset-top, 15px);
}

.safe-area-bottom {
    padding-bottom: env(safe-area-inset-bottom, 15px);
    margin-bottom: env(safe-area-inset-bottom, 0);
}

.safe-touch-area {
    min-height: 48px;
    min-width: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}

/* En-tête fixe avec design futuriste */
.header-fixed {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: var(--header-bg);
    box-shadow: var(--shadow);
    border-bottom: 1px solid var(--border-color);
    padding: 5px 0;
    padding-top: env(safe-area-inset-top, 35px);
    animation: borderPulse 3s infinite alternate;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
}

@keyframes borderPulse {
    0% { border-bottom-color: rgba(30, 144, 255, 0.3); }
    100% { border-bottom-color: rgba(0, 77, 155, 0.7); }
}

/* Contenu principal avec défilement */
.main-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 1rem 0;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 100px;
    margin-top: 250px;
    padding-top: env(safe-area-inset-top, 0);
    padding-bottom: env(safe-area-inset-bottom, 100px);
    position: relative;
}

/* Créer l'effet de particules en arrière-plan */
.main-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 50% 50%, var(--accent-glow) 0%, transparent 50%);
    opacity: 0.1;
    pointer-events: none;
    z-index: -1;
    animation: pulse 10s infinite alternate;
}

@keyframes pulse {
    0% { opacity: 0.05; transform: scale(0.8); }
    100% { opacity: 0.2; transform: scale(1.2); }
}

/* Styles pour les sections */
.section-container {
    background-color: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow);
    margin: 0 10px 20px;
    padding: 15px 0;
    position: relative;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--border-color);
    overflow: hidden;
    animation: fadeInUp 0.5s ease-out forwards;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Style pour le bouton de retour */
.btn-circle {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--input-bg);
    color: var(--text-color);
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    flex-shrink: 0;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid var(--border-color);
}

.btn-circle:hover, .btn-circle:focus {
    background: var(--accent-color);
    color: white;
    transform: scale(1.1) translateY(-2px);
    box-shadow: 0 6px 12px var(--accent-glow);
}

/* Style pour le badge de statut */
.status-badge {
    margin-left: auto;
}

.status-badge .badge {
    font-size: 0.9rem;
    font-weight: 500;
    padding: 0.5em 0.85em;
    border-radius: 50px;
    letter-spacing: 0.3px;
    box-shadow: 0 4px 8px var(--accent-glow);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

/* Panel d'information avec style futuriste */
.info-panel {
    background: var(--panel-bg);
    padding: 12px 15px;
    border-bottom-left-radius: 20px;
    border-bottom-right-radius: 20px;
    margin-top: 5px;
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
}

.client-info, .device-info {
    font-size: 0.9rem;
    color: var(--text-color);
}

.info-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.info-item i {
    width: 22px;
    margin-right: 10px;
    text-align: center;
    font-size: 1rem;
    margin-top: 3px;
    color: var(--accent-color);
    text-shadow: 0 0 10px var(--accent-glow);
}

/* Design futuriste pour l'affichage du prix */
.info-price {
    background: linear-gradient(135deg, rgba(30, 144, 255, 0.1), rgba(0, 77, 155, 0.2));
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

.info-price::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
    opacity: 0;
    transform: scale(0.5);
    transition: opacity 0.5s, transform 0.5s;
    pointer-events: none;
}

.info-price:hover {
    background: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(0, 77, 155, 0.3));
    transform: translateY(-3px);
    box-shadow: 0 6px 12px var(--accent-glow);
}

.info-price:hover::before {
    opacity: 0.7;
    transform: scale(1);
}

.info-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.price-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent-color);
    text-shadow: 0 0 8px var(--accent-glow);
}

.problem-text, .notes-text {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal;
    line-height: 1.4;
    color: var(--text-color);
}

.notes-text {
    position: relative;
    padding-right: 20px;
    transition: all 0.3s ease;
    color: var(--text-secondary);
    font-style: italic;
}

.notes-text::after {
    content: '\f044';
    font-family: 'Font Awesome 5 Free';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8rem;
    opacity: 0.7;
    transition: opacity 0.3s ease;
    color: var(--accent-color);
}

.notes-text:hover::after {
    opacity: 1;
}

.notes-text:hover {
    color: var(--accent-color);
    background-color: rgba(30, 144, 255, 0.1);
    border-radius: 4px;
}

/* Design futuriste pour les boutons d'action */
.action-buttons {
    padding: 20px 15px;
    margin-top: 10px;
    background-color: transparent;
}

.action-title {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 25px;
}

.action-title h6 {
    margin: 0 15px;
    font-weight: 700;
    color: var(--text-color);
    font-size: 1.05rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    text-shadow: 0 0 10px var(--accent-glow);
}

.action-title .line {
    flex: 1;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
    animation: linePulse 3s infinite alternate;
}

@keyframes linePulse {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}

.final-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}

.button-row {
    display: flex;
    gap: 15px;
    justify-content: center;
    width: 100%;
}

/* Design des boutons d'action avec effet futuriste */
.final-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 110px;
    height: 110px;
    border: none;
    border-radius: 18px;
    color: white;
    padding: 15px;
    font-weight: 700;
    margin: 0;
    flex: 1;
    max-width: 110px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    animation: buttonAppear 0.5s ease-out forwards;
}

@keyframes buttonAppear {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

.final-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0));
    pointer-events: none;
    z-index: 1;
}

.final-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: 0.5s;
    pointer-events: none;
}

.final-btn:hover::after {
    left: 100%;
}

.final-btn i {
    font-size: 2rem;
    margin-bottom: 10px;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 2;
}

.final-btn span {
    font-size: 1.05rem;
    letter-spacing: 0.03em;
    position: relative;
    z-index: 2;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* Couleurs des boutons avec dégradés modernes */
.restitue-btn { background: linear-gradient(135deg, #28a745, #218838); }
.gardiennage-btn { background: linear-gradient(135deg, #6f42c1, #5e38a4); }
.demarrer-btn { background: linear-gradient(135deg, #007bff, #0056b3); }
.terminer-btn { background: linear-gradient(135deg, #dc3545, #b21f2d); }
.photo-btn { background: linear-gradient(135deg, #3498db, #2980b9); }
.commande-btn { background: linear-gradient(135deg, #f39c12, #d35400); }
.sms-btn { background: linear-gradient(135deg, #2ecc71, #27ae60); }
.devis-btn { background: linear-gradient(135deg, #e83e8c, #b02a5b); }

.final-btn:hover {
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0 15px 25px rgba(0, 0, 0, 0.3);
    animation: btnGlow 1.5s infinite alternate;
}

@keyframes btnGlow {
    0% { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); }
    100% { box-shadow: 0 15px 35px var(--accent-glow); }
}

.final-btn:active {
    transform: translateY(2px);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
    animation: btnShake 0.3s;
}

@keyframes btnShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-3px); }
    50% { transform: translateX(3px); }
    75% { transform: translateX(-3px); }
}

/* Styles pour les modale futuristes */
.modal-content {
    background: var(--modal-bg);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    overflow: hidden;
}

.modal-header {
    background: var(--header-bg);
    border-bottom: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

.modal-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
    animation: scanline 3s linear infinite;
}

@keyframes scanline {
    0% { opacity: 0; transform: translateX(-100%); }
    50% { opacity: 1; }
    100% { opacity: 0; transform: translateX(100%); }
}

.modal-title {
    color: var(--text-color);
    font-weight: 700;
    text-shadow: 0 0 10px var(--accent-glow);
}

.modal-footer {
    border-top: 1px solid var(--border-color);
    background: rgba(0, 0, 0, 0.05);
}

/* Styles adaptés pour les formulaires */
.form-control, .form-select {
    background-color: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    color: var(--text-color);
    transition: all 0.3s;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.form-control:focus, .form-select:focus {
    box-shadow: 0 0 0 3px var(--accent-glow);
    border-color: var(--accent-color);
    background-color: rgba(255, 255, 255, 0.1);
}

/* Amélioration des boutons */
.btn-primary {
    background: var(--btn-gradient);
    border: none;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
}

.btn-primary::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: 0.5s;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px var(--accent-glow);
}

.btn-primary:hover::after {
    left: 100%;
}

.btn-primary:active {
    transform: translateY(1px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

/* Animation pour le shimmer sur les éléments interactifs */
@keyframes shimmer {
    0% {
        background-position: -100% 0;
    }
    100% {
        background-position: 100% 0;
    }
}

/* Style holographique pour les éléments de succès */
.bg-success {
    background: linear-gradient(135deg, #28a745, #218838);
    position: relative;
    overflow: hidden;
}

.bg-success::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.1) 50%,
        rgba(255, 255, 255, 0) 100%
    );
    transform: rotate(30deg);
    animation: holographic 3s linear infinite;
}

@keyframes holographic {
    0% { transform: rotate(30deg) translateX(-100%); }
    100% { transform: rotate(30deg) translateX(100%); }
}

/* Responsivité pour différentes tailles d'écran */
@media (max-width: 400px) {
    .final-btn {
        width: 100px;
        height: 100px;
        padding: 12px;
    }
    
    .final-btn i {
        font-size: 1.8rem;
    }
    
    .final-btn span {
        font-size: 0.95rem;
    }
}

/* Styles iOS et Android spécifiques */
.ios-device .header-fixed {
    padding-top: env(safe-area-inset-top, 50px);
}

.ios-device .main-content {
    margin-top: 280px;
}

.android-device .header-fixed {
    padding-top: env(safe-area-inset-top, 40px);
}

.android-device .main-content {
    margin-top: 260px;
}

/* Styles pour l'interface des photos */
.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
    padding: 10px 0;
    max-height: 60vh;
    overflow-y: auto;
}

.photo-item {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    aspect-ratio: 1;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 1px solid var(--border-color);
    animation: fadeIn 0.5s ease-out forwards;
    animation-delay: calc(var(--animation-order) * 0.1s);
    opacity: 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.photo-item:hover {
    transform: translateY(-5px) scale(1.03);
    box-shadow: 0 8px 20px var(--accent-glow);
    z-index: 2;
}

.photo-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
}

.photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    filter: brightness(0.95);
    transition: filter 0.3s ease;
}

.photo-item:hover img {
    filter: brightness(1.05);
}

.photo-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent 70%);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 10px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.photo-item:hover .photo-overlay {
    opacity: 1;
}

.photo-actions {
    display: flex;
    justify-content: flex-end;
}

.photo-description {
    color: white;
    font-size: 0.8rem;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    background: rgba(0, 0, 0, 0.6);
    padding: 8px;
    border-radius: 8px;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Styles supplémentaires adaptés à l'application */
.info-status, .info-password {
    background: linear-gradient(135deg, rgba(30, 144, 255, 0.1), rgba(0, 77, 155, 0.2));
    padding: 8px 12px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
    border: 1px solid var(--border-color);
}

.info-status:hover, .info-password:hover {
    background: linear-gradient(135deg, rgba(30, 144, 255, 0.2), rgba(0, 77, 155, 0.3));
    transform: translateY(-2px);
    box-shadow: 0 6px 12px var(--accent-glow);
}

.status-value, .password-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--accent-color);
    text-shadow: 0 0 10px var(--accent-glow);
}

/* Animation des éléments d'interface au survol */
.info-item:hover i {
    animation: iconPulse 1s infinite alternate;
}

@keyframes iconPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.2); }
}
</style>

<script>
// Attendre que le DOM soit complètement chargé
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM chargé, initialisation des composants...");
    
    // Variables pour la gestion de la caméra
    let stream = null;
    
    // Initialisation des modals
    const photoModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    const photosModal = new bootstrap.Modal(document.getElementById('photosModal'));
    const viewPhotoModal = new bootstrap.Modal(document.getElementById('viewPhotoModal'));
    
    // Initialiser le modal des statuts manuellement
    const statutModalElement = document.getElementById('statutModal');
    if (statutModalElement) {
        // Vérifier que bootstrap est chargé
        if (typeof bootstrap !== 'undefined') {
            try {
                const statutModal = new bootstrap.Modal(statutModalElement, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                
                // Ajouter un gestionnaire pour les boutons dans le modal
                document.querySelectorAll('.status-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        // Fermer le modal
                        statutModal.hide();
                    });
                });
                
                // Gestionnaire pour les onglets de catégorie
                const categoryTabs = document.querySelectorAll('#categoryTabs .nav-link');
                if (categoryTabs.length > 0) {
                    console.log("Onglets de catégorie initialisés avec succès");
                    categoryTabs.forEach(tab => {
                        tab.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            // Désactiver tous les onglets
                            categoryTabs.forEach(t => {
                                t.classList.remove('active');
                                t.setAttribute('aria-selected', 'false');
                            });
                            
                            // Activer l'onglet cliqué
                            this.classList.add('active');
                            this.setAttribute('aria-selected', 'true');
                            
                            // Afficher le contenu correspondant
                            const targetId = this.getAttribute('data-bs-target');
                            document.querySelectorAll('.tab-pane').forEach(pane => {
                                pane.classList.remove('show', 'active');
                            });
                            const targetPane = document.querySelector(targetId);
                            if (targetPane) {
                                targetPane.classList.add('show', 'active');
                            }
                        });
                    });
                } else {
                    console.log("Aucun onglet de catégorie trouvé");
                }
            } catch (e) {
                console.error("Erreur d'initialisation du modal:", e);
            }
        } else {
            console.error("Bootstrap n'est pas chargé");
        }
    }
    
    // Initialiser le modal des notes techniques
    const notesText = document.querySelector('.notes-text');
    if (notesText) {
        notesText.addEventListener('click', function() {
            const notesModal = new bootstrap.Modal(document.getElementById('notesModal'));
            notesModal.show();
        });
        
        // Ajouter un style de curseur pour indiquer que c'est cliquable
        notesText.style.cursor = 'pointer';
        
        // Ajouter un effet de survol
        notesText.addEventListener('mouseover', function() {
            this.classList.add('text-primary');
        });
        
        notesText.addEventListener('mouseout', function() {
            this.classList.remove('text-primary');
        });
        
        // Gestionnaire pour le bouton d'historique
        document.getElementById('viewHistoryBtn')?.addEventListener('click', function() {
            // Rediriger vers la page d'historique des modifications avec l'ID de la réparation
            window.location.href = 'index.php?page=historique&reparation_id=<?php echo $reparation_id; ?>&filter=notes';
        });
    }
    
    // Initialiser le modal de finalisation
    const terminerModalElement = document.getElementById('terminerModal');
    if (terminerModalElement) {
        if (typeof bootstrap !== 'undefined') {
            try {
                // Initialiser le modal
                const terminerModal = new bootstrap.Modal(terminerModalElement, {
                    backdrop: true,
                    keyboard: true,
                    focus: true
                });
                
                // Trouver et initialiser le bouton Confirmer
                const btnConfirmer = document.getElementById('confirmerTerminer');
                if (btnConfirmer) {
                    console.log("Initialisation de l'événement onclick pour le bouton Confirmer");
                    
                    btnConfirmer.addEventListener('click', function() {
                        const statutSelected = document.querySelector('input[name="nouveau_statut"]:checked');
                        if (!statutSelected) {
                            alert('Veuillez sélectionner un statut.');
                            return;
                        }
                        
                        const nouveau_statut = statutSelected.value;
                        terminerModal.hide();
                        
                        // Envoyer la requête
                        fetch('ajax/manage_repair_attribution.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'terminer',
                                reparation_id: <?php echo $reparation_id; ?>,
                                nouveau_statut: nouveau_statut
                            }),
                            credentials: 'include'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Réparation terminée avec succès!');
                                window.location.href = 'index.php?page=reparations';
                            } else {
                                alert(data.message || 'Une erreur est survenue.');
                            }
                        })
                        .catch(error => {
                            console.error('Erreur:', error);
                            alert('Une erreur de communication est survenue.');
                        });
                    });
                }
            } catch (e) {
                console.error("Erreur d'initialisation du modal terminer:", e);
            }
        }
    }
    
    // Initialiser les boutons d'action finaux
    document.querySelectorAll('.final-btn').forEach(btn => {
        btn.addEventListener('touchstart', function() {
            this.classList.add('pressed');
        });
        
        btn.addEventListener('touchend', function() {
            this.classList.remove('pressed');
        });
    });
    console.log("Feedback tactile des boutons finaux initialisé");
    
    // Gestionnaire pour le bouton Démarrer
    const btnDemarrer = document.getElementById('btnDemarrer');
    if (btnDemarrer) {
        btnDemarrer.addEventListener('click', function() {
            const formData = new FormData(document.getElementById('demarrerForm'));
            const jsonData = {
                action: formData.get('action'),
                reparation_id: formData.get('reparation_id'),
                user_id: formData.get('user_id'),
                user_token: formData.get('user_token')
            };
            
            fetch('ajax/manage_repair_attribution.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(jsonData),
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.active_repairs && data.active_repairs.length > 0) {
                        const activeRepairId = data.active_repairs[0].id;
                        
                        if (confirm('Vous avez déjà des réparations actives. Vous allez être redirigé vers cette réparation pour la clôturer.')) {
                            window.location.href = `index.php?page=statut_rapide&id=${activeRepairId}`;
                        }
                    } else if (data.other_workers && data.other_workers.length > 0) {
                        const workers = data.other_workers.map(w => w.nom).join(', ');
                        if (confirm(`Les techniciens suivants travaillent déjà sur cette réparation: ${workers}. Voulez-vous aussi y travailler?`)) {
                            confirmerDemarrage();
                        }
                    } else {
                        confirmerDemarrage();
                    }
                } else {
                    alert(data.message || 'Une erreur est survenue lors de la vérification.');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la communication avec le serveur.');
            });
        });
    }
    
    // Gestionnaire pour le bouton Ajouter photo
    const btnAjouterPhoto = document.getElementById('btn-ajouter-photo');
    if (btnAjouterPhoto) {
        btnAjouterPhoto.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Fermer le modal des photos
            photosModal.hide();
            
            // Laisser un délai pour éviter les conflits de modals
            setTimeout(() => {
                // Initialiser le flux de la caméra
                startCamera();
                
                // Afficher le modal photo
                photoModal.show();
            }, 500);
        });
    }
    
    // Gestionnaire pour les boutons de visualisation de photo
    document.querySelectorAll('.view-photo-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Empêcher la propagation au parent
            
            // Récupérer l'URL de la photo
            const photoUrl = this.getAttribute('data-url');
            
            // Définir l'URL sur l'image du modal
            document.getElementById('fullsizePhoto').src = photoUrl;
            
            // Afficher le modal
            viewPhotoModal.show();
        });
    });
    
    // Gestionnaire pour les boutons de suppression de photo
    document.querySelectorAll('.delete-photo-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Empêcher la propagation au parent
            
            // Demander confirmation
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette photo ?')) {
                return;
            }
            
            // Récupérer l'ID de la photo
            const photoId = this.getAttribute('data-id');
            
            // Préparer les données pour la requête
            const formData = new FormData();
            formData.append('photo_id', photoId);
            
            // Envoyer la requête de suppression
            fetch('ajax/delete_photo.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Supprimer l'élément de la grille
                    const photoItem = document.querySelector(`.photo-item[data-id="${photoId}"]`);
                    if (photoItem) {
                        photoItem.remove();
                    }
                    
                    // Si plus de photos, afficher le message vide
                    if (document.querySelectorAll('.photo-item').length === 0) {
                        const photoGrid = document.querySelector('.photo-grid');
                        if (photoGrid) {
                            photoGrid.innerHTML = `
                            <div class="text-center py-5">
                                <div class="mb-3">
                                    <i class="fas fa-camera-retro fa-4x text-muted"></i>
                                </div>
                                <h4 class="text-muted">Aucune photo disponible</h4>
                                <p class="text-muted">Cliquez sur "Ajouter une photo" pour commencer à documenter cette réparation.</p>
                            </div>`;
                        }
                    }
                    
                    // Afficher un message de succès
                    alert('Photo supprimée avec succès !');
                } else {
                    // Afficher un message d'erreur
                    alert(data.error || 'Une erreur est survenue lors de la suppression de la photo.');
                }
            })
            .catch(error => {
                console.error('Erreur :', error);
                alert('Une erreur est survenue lors de la communication avec le serveur.');
            });
        });
    });
    
    // Rendre les items de photo cliquables pour visualiser
    document.querySelectorAll('.photo-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Ne pas traiter si le clic vient d'un bouton d'action
            if (e.target.closest('.photo-actions')) {
                return;
            }
            
            // Récupérer l'URL de la photo
            const photoUrl = this.getAttribute('data-url');
            
            // Définir l'URL sur l'image du modal
            document.getElementById('fullsizePhoto').src = photoUrl;
            
            // Afficher le modal
            viewPhotoModal.show();
        });
    });
    
    // Fonction pour démarrer la caméra
    function startCamera() {
        const videoElement = document.getElementById('camera');
        const captureBtn = document.getElementById('captureBtn');
        const savePhotoBtn = document.getElementById('savePhotoBtn');
        const cameraContainer = document.getElementById('cameraContainer');
        const photoPreview = document.getElementById('photoPreview');
        const previewImage = document.getElementById('previewImage');
        const retakeBtn = document.getElementById('retakePhoto');
        
        if (!videoElement || !captureBtn) return;
        
        // Contraintes pour la caméra
        const constraints = {
            video: {
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            },
            audio: false
        };
        
        // Arrêter tout flux actif
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        
        // Accéder à la caméra
        navigator.mediaDevices.getUserMedia(constraints)
            .then(function(mediaStream) {
                stream = mediaStream;
                videoElement.srcObject = mediaStream;
                
                // Afficher la vidéo et masquer la prévisualisation
                cameraContainer.classList.remove('d-none');
                photoPreview.classList.add('d-none');
                captureBtn.classList.remove('d-none');
                savePhotoBtn.classList.add('d-none');
                
                // Gestionnaire pour capturer l'image
                captureBtn.addEventListener('click', function() {
                    const canvas = document.getElementById('cameraCanvas');
                    const context = canvas.getContext('2d');
                    
                    // Définir les dimensions du canvas
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    
                    // Dessiner l'image
                    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                    
                    // Convertir en URL de données
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    
                    // Afficher la prévisualisation
                    previewImage.src = dataUrl;
                    cameraContainer.classList.add('d-none');
                    photoPreview.classList.remove('d-none');
                    captureBtn.classList.add('d-none');
                    savePhotoBtn.classList.remove('d-none');
                });
                
                // Gestionnaire pour reprendre une photo
                retakeBtn.addEventListener('click', function() {
                    cameraContainer.classList.remove('d-none');
                    photoPreview.classList.add('d-none');
                    captureBtn.classList.remove('d-none');
                    savePhotoBtn.classList.add('d-none');
                });
                
                // Gestionnaire pour sauvegarder la photo
                savePhotoBtn.addEventListener('click', async function() {
                    const form = document.getElementById('cameraForm');
                    if (!form) return;
                    
                    const formData = new FormData(form);
                    
                    try {
                        this.disabled = true;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sauvegarde en cours...';
                        
                        // Convertir la photo du canvas en blob
                        const canvas = document.getElementById('cameraCanvas');
                        if (!canvas) {
                            throw new Error('Canvas non trouvé');
                        }
                        
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
                        formData.set('photo', blob, 'photo.jpg');
                        
                        // Envoyer la photo
                        const response = await fetch('ajax/upload_photo.php', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // Afficher un message de succès
                            alert('Photo ajoutée avec succès !');
                            
                            // Fermer le modal et réinitialiser
                            photoModal.hide();
                            form.reset();
                            
                            // Recharger la page pour afficher la nouvelle photo
                            window.location.reload();
                        } else {
                            throw new Error(data.error || 'Erreur lors de l\'upload de la photo');
                        }
                    } catch (error) {
                        console.error('Erreur:', error);
                        alert(`Erreur lors de la sauvegarde de la photo: ${error.message}`);
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-save me-2"></i> Sauvegarder';
                    }
                });
                
                // Arrêter la caméra à la fermeture du modal
                document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                });
            })
            .catch(function(err) {
                console.error("Erreur lors de l'accès à la caméra: ", err);
                alert("Impossible d'accéder à la caméra. Vérifiez que vous avez accordé les permissions nécessaires.");
        });
    }
    
    // Gestionnaire pour le bouton Commander pièce
    const btnCommanderPiece = document.getElementById('btn-commander-piece');
    if (btnCommanderPiece) {
        btnCommanderPiece.addEventListener('click', function(e) {
            // Préparation des données pour le modal commande
            const reparationId = this.getAttribute('data-reparation-id');
            const clientId = this.getAttribute('data-client-id');
            
            // On attend que le modal soit chargé avant de définir les valeurs
            $('#ajouterCommandeModal').on('shown.bs.modal', function() {
                // Remplir les champs du formulaire
                if (document.getElementById('reparation_id')) {
                    document.getElementById('reparation_id').value = reparationId;
                }
                
                if (document.getElementById('client_id')) {
                    document.getElementById('client_id').value = clientId;
                }
                
                // Mettre à jour l'affichage du client sélectionné
                if (document.getElementById('client_selectionne')) {
                    document.getElementById('client_selectionne').classList.remove('d-none');
                    const nomClientElement = document.querySelector('#client_selectionne .nom_client');
                    if (nomClientElement) {
                        nomClientElement.textContent = '<?php echo htmlspecialchars($reparation['client_nom'] . ' ' . $reparation['client_prenom']); ?>';
                    }
                    
                    const telClientElement = document.querySelector('#client_selectionne .tel_client');
                    if (telClientElement) {
                        telClientElement.textContent = '<?php echo htmlspecialchars($reparation['client_telephone']); ?>';
                    }
                }
                
                // Préremplir le champ nom client selectionné
                if (document.getElementById('nom_client_selectionne')) {
                    document.getElementById('nom_client_selectionne').value = '<?php echo htmlspecialchars($reparation['client_nom'] . ' ' . $reparation['client_prenom']); ?>';
                }
            });
            
            // Le modal sera ouvert par l'attribut data-bs-target
        });
    }
    
    // Initialiser le comportement du prix cliquable
    const prixContainer = document.getElementById('prixContainer');
    const prixValue = document.getElementById('prixValue');
    const prixModalEl = document.getElementById('prixModal');
    const prixModal = new bootstrap.Modal(prixModalEl);
    let currentPrice = 0;
    let keyboardListenerActive = false;  // Flag pour suivre si l'écouteur clavier est actif
    
    // Initialiser la valeur actuelle du prix
    if (prixValue) {
        // Extraire la valeur numérique du prix affiché
        const priceText = prixValue.textContent.trim();
        if (priceText !== 'Non défini') {
            const prixMatch = priceText.match(/(\d+(?:\s\d+)*)/);
            if (prixMatch) {
                // Convertir le prix extrait en nombre entier
                currentPrice = parseInt(prixMatch[0].replace(/\s/g, ''));
            }
        }
    }
    
    // Ajouter l'événement de clic sur le prix
    if (prixContainer) {
        prixContainer.style.cursor = 'pointer';
        prixContainer.addEventListener('click', function() {
            // Mettre à jour l'affichage du prix dans le modal
            document.getElementById('prixDisplay').textContent = currentPrice + ' €';
            // Ouvrir le modal
            prixModal.show();
        });
    }
    
    // Gestionnaire pour les événements clavier - fonction séparée pour pouvoir la détacher facilement
    function handleGlobalKeyDown(event) {
        // Vérifier si le modal est ouvert
        if (!prixModalEl.classList.contains('show')) {
            return;
        }
        
        // Bloquer l'événement sur toutes les touches numériques, delete et backspace
        if (/^[0-9]$/.test(event.key) || event.key === 'Backspace' || event.key === 'Delete') {
            console.log('Bloqué:', event.key);
            event.preventDefault();
            event.stopPropagation();
            
            // Pour les touches numériques, faire le traitement
            if (/^[0-9]$/.test(event.key)) {
                handleNumpadInput(event.key);
            } else if (event.key === 'Backspace' || event.key === 'Delete') {
                // Gérer la suppression
                const prixDisplay = document.getElementById('prixDisplay');
                let newPrice = prixDisplay.textContent.replace(/\s|€/g, '');
                
                if (newPrice.length > 1) {
                    newPrice = newPrice.substring(0, newPrice.length - 1);
                } else {
                    newPrice = '0';
                }
                
                prixDisplay.textContent = newPrice + ' €';
                currentPrice = parseInt(newPrice);
            }
        } else if (event.key === 'Enter') {
            event.preventDefault();
            event.stopPropagation();
            savePrice();
        }
    }
    
    // Nous devons ajouter l'écouteur d'événements au niveau du document,
    // car il interceptera les événements clavier avant qu'ils n'atteignent le modal
    prixModalEl.addEventListener('shown.bs.modal', function() {
        if (!keyboardListenerActive) {
            console.log('Ajout de l\'écouteur clavier');
            keyboardListenerActive = true;
            document.addEventListener('keydown', handleGlobalKeyDown, true); // true pour la phase de capture
        }
    });
    
    // Supprimer l'écouteur lors de la fermeture pour éviter les fuites de mémoire
    prixModalEl.addEventListener('hidden.bs.modal', function() {
        if (keyboardListenerActive) {
            console.log('Suppression de l\'écouteur clavier');
            keyboardListenerActive = false;
            document.removeEventListener('keydown', handleGlobalKeyDown, true);
        }
    });
    
    // Gérer le clavier numérique (les boutons virtuels)
    const numpadKeys = document.querySelectorAll('.numpad-key');
    if (numpadKeys.length > 0) {
        numpadKeys.forEach(key => {
            key.addEventListener('click', function(e) {
                e.preventDefault();
                const value = this.getAttribute('data-value');
                handleNumpadInput(value);
            });
        });
    }
    
    // Gérer les touches du clavier numérique
    function handleNumpadInput(value) {
        const prixDisplay = document.getElementById('prixDisplay');
        const currentText = prixDisplay.textContent;
        let newPrice = currentText.replace(/\s|€/g, '');
        
        if (value === 'C') {
            // Effacer tout
            newPrice = '0';
        } else if (value === '.') {
            // Ne rien faire pour le point (pas utilisé pour les prix entiers)
            return;
        } else {
            // Gérer les autres touches numériques
            if (newPrice === '0') {
                newPrice = value; // Remplacer le 0 initial
            } else {
                newPrice += value; // Ajouter le chiffre
            }
        }
        
        // Limiter à 5 chiffres maximum (prix raisonnable)
        if (newPrice.length > 5) {
            newPrice = newPrice.substring(0, 5);
        }
        
        // Mettre à jour l'affichage
        prixDisplay.textContent = newPrice + ' €';
        currentPrice = parseInt(newPrice);
    }
    
    // Gérer le bouton de sauvegarde du prix
    const savePrixBtn = document.getElementById('savePrixBtn');
    if (savePrixBtn) {
        savePrixBtn.addEventListener('click', function() {
            savePrice();
        });
    }
    
    // Fonction pour enregistrer le prix
    function savePrice() {
        // Préparer les données à envoyer
        const formData = new FormData();
        formData.append('repair_id', <?php echo $reparation_id; ?>);
        formData.append('price', currentPrice);
        
        // Envoyer la requête AJAX
        fetch('ajax/update_repair_price.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mettre à jour l'affichage du prix
                prixValue.textContent = currentPrice.toLocaleString('fr-FR') + ' €';
                // Fermer le modal
                prixModal.hide();
                
                // Afficher un message de confirmation
                alert('Prix mis à jour avec succès');
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la mise à jour du prix');
        });
    }

    // Ajouter un événement pour charger les réparations lorsque le modal s'ouvre
    document.addEventListener('shown.bs.modal', function(event) {
        // Vérifier si c'est bien le modal de commande qui est ouvert
        if (event.target.id === 'ajouterCommandeModal') {
            const clientId = document.getElementById('client_id').value;
            if (clientId) {
                chargerReparationsClient(clientId);
            }
        }
    });
    
    // Gestionnaire pour le bouton Envoyer devis
    const btnEnvoyerDevis = document.getElementById('btn-envoyer-devis');
    const confirmerDevisBtn = document.getElementById('confirmer-devis-btn');
    
    if (btnEnvoyerDevis && confirmerDevisBtn) {
        confirmerDevisBtn.addEventListener('click', function() {
            const montant = document.getElementById('devis-montant').value;
            const updatePrix = document.getElementById('devis-update-prix').checked;
            
            if (!montant || parseFloat(montant) <= 0) {
                alert('Veuillez saisir un montant valide pour le devis.');
                return;
            }
            
            // Préparer les données à envoyer
            const formData = new FormData();
            formData.append('action', 'envoyer_devis');
            formData.append('reparation_id', <?php echo $reparation_id; ?>);
            formData.append('montant', montant);
            formData.append('update_prix', updatePrix ? '1' : '0');
            // Ajouter l'ID utilisateur pour l'authentification directe (alternative)
            <?php if (isset($_SESSION['user_id'])) : ?>
            formData.append('user_id', <?php echo $_SESSION['user_id']; ?>);
            <?php endif; ?>
            
            // Fermer le modal
            const devisModal = bootstrap.Modal.getInstance(document.getElementById('devisModal'));
            devisModal.hide();
            
            // Afficher un indicateur de chargement
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
            loadingIndicator.style.zIndex = '9999';
            loadingIndicator.innerHTML = `
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            `;
            document.body.appendChild(loadingIndicator);
            
            // Envoyer la requête AJAX
            fetch('ajax/process_devis.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Supprimer l'indicateur de chargement
                document.body.removeChild(loadingIndicator);
                
                if (data.success) {
                    alert('Le devis a été envoyé avec succès au client.');
                    // Rediriger vers la page d'accueil
                    window.location.href = 'index.php';
                } else {
                    alert('Erreur: ' + (data.message || 'Une erreur est survenue lors de l\'envoi du devis.'));
                }
            })
            .catch(error => {
                // Supprimer l'indicateur de chargement
                document.body.removeChild(loadingIndicator);
                
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la communication avec le serveur.');
            });
        });
    }
    
    // Gestionnaire pour le bouton Gardiennage
    const btnGardiennage = document.getElementById('btn-gardiennage');
    const confirmerGardiennageBtn = document.getElementById('confirmer-gardiennage-btn');
    
    if (btnGardiennage && confirmerGardiennageBtn) {
        confirmerGardiennageBtn.addEventListener('click', function() {
            const notes = document.getElementById('gardiennage-notes').value;
            
            // Préparer les données à envoyer
            const formData = new FormData();
            formData.append('action', 'gardiennage');
            formData.append('reparation_id', <?php echo $reparation_id; ?>);
            formData.append('notes', notes);
            
            // Fermer le modal
            const gardiennageModal = bootstrap.Modal.getInstance(document.getElementById('gardiennageModal'));
            gardiennageModal.hide();
            
            // Afficher un indicateur de chargement
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
            loadingIndicator.style.zIndex = '9999';
            loadingIndicator.innerHTML = `
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            `;
            document.body.appendChild(loadingIndicator);
            
            // Envoyer la requête AJAX
            fetch('ajax/process_gardiennage.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Supprimer l'indicateur de chargement
                document.body.removeChild(loadingIndicator);
                
                if (data.success) {
                    alert('L\'appareil a été placé en gardiennage avec succès.');
                    // Rediriger vers la page d'accueil
                    window.location.href = 'index.php';
                } else {
                    alert('Erreur: ' + (data.message || 'Une erreur est survenue lors du placement en gardiennage.'));
                }
            })
            .catch(error => {
                // Supprimer l'indicateur de chargement
                document.body.removeChild(loadingIndicator);
                
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la communication avec le serveur.');
            });
        });
    }
});

// Fonction pour confirmer le démarrage d'une réparation
function confirmerDemarrage() {
    // Récupérer l'ID de la réparation depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const reparationId = urlParams.get('id');
    
    if (!reparationId) {
        alert('Erreur: ID de réparation non trouvé');
        return;
    }
    
    // Appeler l'API pour confirmer le démarrage
    fetch('ajax/manage_repair_attribution.php', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            action: 'confirmer_demarrage',
            reparation_id: reparationId,
            employe_id: <?php echo $_SESSION['user_id']; ?>,
            est_principal: 1
        }),
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Réparation démarrée avec succès!');
            // Recharger la page pour afficher les changements
            window.location.reload();
        } else {
            alert(data.message || 'Erreur lors du démarrage de la réparation');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur de communication est survenue');
    });
}

// Détection du système d'exploitation mobile
document.addEventListener('DOMContentLoaded', function() {
    // Détecter iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    // Détecter Android
    const isAndroid = /Android/.test(navigator.userAgent);
    
    // Ajouter des classes spécifiques au body
    if (isIOS) {
        document.body.classList.add('ios-device');
    } else if (isAndroid) {
        document.body.classList.add('android-device');
    }
    
    // Ajuster la hauteur de l'en-tête pour les appareils iOS
    if (isIOS) {
        const headerFixed = document.querySelector('.header-fixed');
        if (headerFixed) {
            // Ajouter plus de padding pour iOS (barre de statut plus grande)
            headerFixed.style.paddingTop = '45px';
        }
    }
    
    console.log("Système détecté:", isIOS ? "iOS" : (isAndroid ? "Android" : "Autre"));
});

// Fonction pour ouvrir le modal SMS (reprise du code existant)
function openSmsModal(clientId, nom, prenom, telephone) {
    // Remplir les informations du client dans le modal
    document.getElementById('client-name-display').textContent = nom + ' ' + prenom;
    document.getElementById('client-phone-display').textContent = telephone;
    document.getElementById('sms-client-id').value = clientId;
    
    // Réinitialiser l'état du modal
    document.querySelectorAll('.sms-option-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Réinitialiser la sélection des templates
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('active');
    });
    document.querySelector('.template-card[data-id="1"]').classList.add('active');
    
    // Vider le champ de texte personnalisé
    const messageTextarea = document.getElementById('sms-message');
    if (messageTextarea) {
        messageTextarea.value = '';
        const charCounter = document.getElementById('sms-char-count');
        if (charCounter) {
            charCounter.textContent = '0';
            charCounter.classList.remove('text-danger', 'fw-bold');
        }
    }
    
    // Masquer les sections de contenu
    document.getElementById('message-content-container').classList.add('d-none');
    document.getElementById('predefined-templates').classList.add('d-none');
    document.getElementById('custom-message').classList.add('d-none');
    
    // Désactiver le bouton d'envoi
    document.getElementById('send-sms-btn').disabled = true;
    
    // Afficher le modal
    const smsModal = new bootstrap.Modal(document.getElementById('smsModal'));
    smsModal.show();
}

// Fonction pour remplir la liste des réparations du client
function chargerReparationsClient(clientId) {
    if (!clientId) return;
    
    // Récupérer l'élément select des réparations
    const reparationSelect = document.getElementById('reparation_id');
    if (!reparationSelect) return;
    
    // Nettoyer les options existantes sauf la première
    while (reparationSelect.options.length > 1) {
        reparationSelect.remove(1);
    }
    
    // Charger les réparations du client via AJAX
    fetch(`ajax/get_client_reparations.php?client_id=${clientId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.reparations) {
                // Ajouter chaque réparation comme option
                data.reparations.forEach(reparation => {
                    const option = document.createElement('option');
                    option.value = reparation.id;
                    option.textContent = `#${reparation.id} - ${reparation.type_appareil} ${reparation.marque} ${reparation.modele}`;
                    
                    // Sélectionner automatiquement la réparation courante
                    if (reparation.id == <?php echo $reparation_id; ?>) {
                        option.selected = true;
                    }
                    
                    reparationSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des réparations:', error);
        });
}

// Ajouter un événement pour charger les réparations lorsque le modal s'ouvre
document.addEventListener('shown.bs.modal', function(event) {
    // Vérifier si c'est bien le modal de commande qui est ouvert
    if (event.target.id === 'ajouterCommandeModal') {
        const clientId = document.getElementById('client_id').value;
        if (clientId) {
            chargerReparationsClient(clientId);
        }
    }
});

// Gestionnaire pour le bouton Envoyer devis
const btnEnvoyerDevis = document.getElementById('btn-envoyer-devis');
const confirmerDevisBtn = document.getElementById('confirmer-devis-btn');

if (btnEnvoyerDevis && confirmerDevisBtn) {
    confirmerDevisBtn.addEventListener('click', function() {
        const montant = document.getElementById('devis-montant').value;
        const updatePrix = document.getElementById('devis-update-prix').checked;
        
        if (!montant || parseFloat(montant) <= 0) {
            alert('Veuillez saisir un montant valide pour le devis.');
            return;
        }
        
        // Préparer les données à envoyer
        const formData = new FormData();
        formData.append('action', 'envoyer_devis');
        formData.append('reparation_id', <?php echo $reparation_id; ?>);
        formData.append('montant', montant);
        formData.append('update_prix', updatePrix ? '1' : '0');
        // Ajouter l'ID utilisateur pour l'authentification directe (alternative)
        <?php if (isset($_SESSION['user_id'])) : ?>
        formData.append('user_id', <?php echo $_SESSION['user_id']; ?>);
        <?php endif; ?>
        
        // Fermer le modal
        const devisModal = bootstrap.Modal.getInstance(document.getElementById('devisModal'));
        devisModal.hide();
        
        // Afficher un indicateur de chargement
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
        loadingIndicator.style.zIndex = '9999';
        loadingIndicator.innerHTML = `
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        `;
        document.body.appendChild(loadingIndicator);
        
        // Envoyer la requête AJAX
        fetch('ajax/process_devis.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Supprimer l'indicateur de chargement
            document.body.removeChild(loadingIndicator);
            
            if (data.success) {
                alert('Le devis a été envoyé avec succès au client.');
                // Rediriger vers la page d'accueil
                window.location.href = 'index.php';
            } else {
                alert('Erreur: ' + (data.message || 'Une erreur est survenue lors de l\'envoi du devis.'));
            }
        })
        .catch(error => {
            // Supprimer l'indicateur de chargement
            document.body.removeChild(loadingIndicator);
            
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la communication avec le serveur.');
        });
    });
}

// Gestionnaire pour le bouton Gardiennage
const btnGardiennage = document.getElementById('btn-gardiennage');
const confirmerGardiennageBtn = document.getElementById('confirmer-gardiennage-btn');

if (btnGardiennage && confirmerGardiennageBtn) {
    confirmerGardiennageBtn.addEventListener('click', function() {
        const notes = document.getElementById('gardiennage-notes').value;
        
        // Préparer les données à envoyer
        const formData = new FormData();
        formData.append('action', 'gardiennage');
        formData.append('reparation_id', <?php echo $reparation_id; ?>);
        formData.append('notes', notes);
        
        // Fermer le modal
        const gardiennageModal = bootstrap.Modal.getInstance(document.getElementById('gardiennageModal'));
        gardiennageModal.hide();
        
        // Afficher un indicateur de chargement
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
        loadingIndicator.style.zIndex = '9999';
        loadingIndicator.innerHTML = `
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        `;
        document.body.appendChild(loadingIndicator);
        
        // Envoyer la requête AJAX
        fetch('ajax/process_gardiennage.php', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Supprimer l'indicateur de chargement
            document.body.removeChild(loadingIndicator);
            
            if (data.success) {
                alert('L\'appareil a été placé en gardiennage avec succès.');
                // Rediriger vers la page d'accueil
                window.location.href = 'index.php';
            } else {
                alert('Erreur: ' + (data.message || 'Une erreur est survenue lors du placement en gardiennage.'));
            }
        })
        .catch(error => {
            // Supprimer l'indicateur de chargement
            document.body.removeChild(loadingIndicator);
            
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de la communication avec le serveur.');
        });
    });
}

// === GESTION DU MODAL SMS ===
document.addEventListener('DOMContentLoaded', function() {
    // Gestionnaires pour les boutons d'option du type de message
    const optionsPredefined = document.querySelector('.sms-option-card.predefini');
    const optionsPersonnalise = document.querySelector('.sms-option-card.personnalise');
    
    // Gestionnaire pour le changement d'option de message
    if (optionsPredefined && optionsPersonnalise) {
        optionsPredefined.addEventListener('click', function() {
            // Mettre à jour les classes actives
            this.classList.add('active');
            optionsPersonnalise.classList.remove('active');
            
            // Afficher le conteneur de message
            document.getElementById('message-content-container').classList.remove('d-none');
            
            // Gérer l'affichage des contenus avec animation
            document.getElementById('predefined-templates').classList.remove('d-none');
            document.getElementById('custom-message').classList.add('d-none');
            
            // Afficher la section des variables
            document.getElementById('variables-section').classList.remove('d-none');
            
            // Activer le bouton si un template est déjà sélectionné
            const activeTemplate = document.querySelector('.template-card.active');
            if (activeTemplate) {
                document.getElementById('send-sms-btn').disabled = false;
            }
        });
        
        optionsPersonnalise.addEventListener('click', function() {
            // Mettre à jour les classes actives
            this.classList.add('active');
            optionsPredefined.classList.remove('active');
            
            // Afficher le conteneur de message
            document.getElementById('message-content-container').classList.remove('d-none');
            
            // Gérer l'affichage des contenus avec animation
            document.getElementById('predefined-templates').classList.add('d-none');
            document.getElementById('custom-message').classList.remove('d-none');
            
            // Afficher la section des variables
            document.getElementById('variables-section').classList.remove('d-none');
            
            // Vérifier si le champ texte contient du texte et ajouter la signature si nécessaire
            const messageTextarea = document.getElementById('sms-message');
            const signature = "\n\nMAISON DU GEEK\n78 BD PAUL DOUMER\n06110 LE CANNET\n08 95 79 59 33";
            
            // Ne pas ajouter la signature ici, elle sera gérée par l'événement input
            
            document.getElementById('send-sms-btn').disabled = messageTextarea.value.trim().length === 0;
            
            // Mettre le focus sur la zone de texte
            setTimeout(() => {
                messageTextarea.focus();
            }, 100);
        });
    }
    
    // Gestionnaire pour les templates SMS
    const templateCards = document.querySelectorAll('.template-card');
    if (templateCards.length > 0) {
        templateCards.forEach(card => {
            card.addEventListener('click', function() {
                // Retirer la classe active de tous les modèles
                document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
                // Ajouter la classe active au modèle sélectionné
                this.classList.add('active');
                
                // Récupérer le contenu du modèle
                const templateContent = this.querySelector('.template-content').textContent;
                
                // Mettre à jour le message personnalisé
                const customMessage = document.getElementById('customMessage');
                customMessage.value = templateContent;
                
                // Activer le bouton d'envoi
                document.getElementById('sendSmsBtn').disabled = false;
                
                // Mettre à jour le compteur de caractères
                updateCharCount();
            });
        });
    }
    
    // Gestionnaire pour l'insertion des variables
    const variableBadges = document.querySelectorAll('.variable-badge');
    if (variableBadges.length > 0) {
        variableBadges.forEach(badge => {
            badge.addEventListener('click', function() {
                const variable = this.textContent;
                const messageTextarea = document.getElementById('sms-message');
                
                if (messageTextarea) {
                    // Insérer la variable à la position du curseur
                    const startPos = messageTextarea.selectionStart;
                    const endPos = messageTextarea.selectionEnd;
                    const textBefore = messageTextarea.value.substring(0, startPos);
                    const textAfter = messageTextarea.value.substring(endPos, messageTextarea.value.length);
                    
                    messageTextarea.value = textBefore + variable + textAfter;
                    
                    // Remettre le focus sur le textarea et repositionner le curseur
                    messageTextarea.focus();
                    messageTextarea.selectionStart = startPos + variable.length;
                    messageTextarea.selectionEnd = startPos + variable.length;
                    
                    // Mettre à jour le compteur de caractères
                    updateCharCount();
                }
            });
        });
    }
    
    // Gestionnaire pour le compteur de caractères
    const messageTextarea = document.getElementById('sms-message');
    const charCounter = document.getElementById('sms-char-count');
    
    if (messageTextarea && charCounter) {
        // Signature obligatoire
        const signature = "\n\nMAISON DU GEEK\n78 BD PAUL DOUMER\n06110 LE CANNET\n08 95 79 59 33";
        
        messageTextarea.addEventListener('input', function() {
            // S'assurer que la signature est toujours présente
            if (!this.value.includes(signature)) {
                const cursorPos = this.selectionStart;
                this.value = this.value + signature;
                // Restaurer la position du curseur
                this.selectionStart = cursorPos;
                this.selectionEnd = cursorPos;
            }
            
            updateCharCount();
            // Activer/désactiver le bouton d'envoi en fonction du contenu
            const contentWithoutSignature = this.value.replace(signature, "").trim();
            document.getElementById('send-sms-btn').disabled = contentWithoutSignature.length === 0;
        });
        
        // S'assurer que la signature est présente dès le chargement
        messageTextarea.addEventListener('focus', function() {
            if (!this.value.includes(signature)) {
                this.value = this.value + signature;
                // Positionner le curseur avant la signature
                this.selectionStart = this.value.indexOf(signature);
                this.selectionEnd = this.selectionStart;
            }
        });
        
        // Empêcher la suppression de la signature
        messageTextarea.addEventListener('keydown', function(e) {
            const sigPos = this.value.indexOf(signature);
            if (sigPos !== -1) {
                const selStart = this.selectionStart;
                const selEnd = this.selectionEnd;
                
                // Vérifier si l'utilisateur tente de supprimer la signature
                if ((e.key === 'Backspace' && selStart > sigPos && selStart <= this.value.length) ||
                    (e.key === 'Delete' && selEnd >= sigPos)) {
                    // Empêcher la suppression de la signature
                    e.preventDefault();
                    
                    // Si une sélection inclut du texte avant la signature, ne supprimer que cette partie
                    if (selStart < sigPos && e.key === 'Delete') {
                        const beforeSig = this.value.substring(0, selStart);
                        this.value = beforeSig + signature;
                        this.selectionStart = beforeSig.length;
                        this.selectionEnd = beforeSig.length;
                        updateCharCount();
                    }
                }
            }
        });
    }
    
    function updateCharCount() {
        if (messageTextarea && charCounter) {
            charCounter.textContent = messageTextarea.value.length;
            
            // Changer la couleur si on dépasse la limite
            if (messageTextarea.value.length > 160) {
                charCounter.classList.add('text-danger');
                charCounter.classList.add('fw-bold');
            } else {
                charCounter.classList.remove('text-danger');
                charCounter.classList.remove('fw-bold');
            }
        }
    }
    
    // Gestionnaire pour l'envoi du SMS
    const sendSmsBtn = document.getElementById('send-sms-btn');
    if (sendSmsBtn) {
        sendSmsBtn.addEventListener('click', function() {
            // Variables pour le message et le client
            let message = '';
            const clientId = document.getElementById('sms-client-id').value;
            const signature = "\n\nMAISON DU GEEK\n78 BD PAUL DOUMER\n06110 LE CANNET\n08 95 79 59 33";
            
            // Déterminer le type de message (prédéfini ou personnalisé)
            const isPredefined = document.querySelector('.sms-option-card.predefini').classList.contains('active');
            
            if (isPredefined) {
                // Récupérer le template sélectionné
                const selectedTemplate = document.querySelector('.template-card.active');
                if (!selectedTemplate) {
                    alert('Veuillez sélectionner un modèle de message.');
                    return;
                }
                
                message = selectedTemplate.querySelector('.template-content').textContent;
                
                // Ajouter la signature si elle n'est pas déjà incluse
                if (!message.includes(signature)) {
                    message += signature;
                }
            } else {
                // Récupérer le message personnalisé
                message = document.getElementById('sms-message').value;
                
                if (!message.trim()) {
                    alert('Veuillez saisir un message.');
                    return;
                }
                
                // S'assurer que la signature est présente
                if (!message.includes(signature)) {
                    message += signature;
                }
            }
            
            // Vérifier que le message n'est pas trop long
            if (message.length > 160) {
                if (!confirm('Le message dépasse la limite de 160 caractères et pourrait être envoyé en plusieurs parties. Continuer ?')) {
                    return;
                }
            }
            
            // Afficher l'icône de chargement
            const spinner = document.getElementById('sms-spinner');
            spinner.classList.remove('d-none');
            sendSmsBtn.disabled = true;
            
            // Préparer les données pour l'envoi
            const formData = new FormData();
            formData.append('action', 'send_sms');
            formData.append('client_id', clientId);
            formData.append('reparation_id', <?php echo $reparation_id; ?>);
            formData.append('message', message);
            
            // Récupérer les informations du client depuis le modal
            const clientName = document.getElementById('client-name-display').textContent;
            let clientPhone = document.getElementById('client-phone-display').textContent;
            
            // Nettoyer le numéro de téléphone (supprimer espaces, tirets, etc.)
            clientPhone = clientPhone.replace(/[^0-9+]/g, '');
            
            // Ajouter le numéro de téléphone au formData
            formData.append('telephone', clientPhone);
            
            // Créer les données de l'API
            fetch('ajax/send_sms.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Masquer l'icône de chargement
                spinner.classList.add('d-none');
                sendSmsBtn.disabled = false;
                
                // Fermer le modal
                const smsModal = bootstrap.Modal.getInstance(document.getElementById('smsModal'));
                smsModal.hide();
                
                if (data.success) {
                    // Afficher un message de succès
                    alert('SMS envoyé avec succès à ' + clientName + ' au ' + clientPhone);
                } else {
                    // Afficher un message d'erreur
                    alert('Erreur lors de l\'envoi du SMS: ' + (data.message || 'Une erreur est survenue'));
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                
                // Masquer l'icône de chargement
                spinner.classList.add('d-none');
                sendSmsBtn.disabled = false;
                
                // Afficher un message d'erreur
                alert('Une erreur est survenue lors de la communication avec le serveur.');
            });
        });
    }
});

// Gestionnaire pour les touches du clavier physique
function handleKeyboardInput(e) {
    // Vérifier si le modal de prix est visible
    const modalElement = document.getElementById('prixModal');
    if (!modalElement.classList.contains('show')) {
        // Si le modal n'est plus visible, supprimer l'écouteur d'événement
        document.removeEventListener('keydown', handleKeyboardInput);
        return;
    }
    
    // Ne traiter que les touches numériques, Backspace, Delete et Escape
    if (/^[0-9]$/.test(e.key)) {
        handleNumpadInput(e.key);
        e.preventDefault(); // Empêcher le comportement par défaut
    } else if (e.key === 'Backspace' || e.key === 'Delete') {
        // Gérer la suppression
        const prixDisplay = document.getElementById('prixDisplay');
        const currentText = prixDisplay.textContent;
        let newPrice = currentText.replace(/\s|€/g, '');
        
        if (newPrice.length > 1) {
            newPrice = newPrice.substring(0, newPrice.length - 1);
        } else {
            newPrice = '0';
        }
        
        prixDisplay.textContent = newPrice + ' €';
        currentPrice = parseInt(newPrice);
        e.preventDefault();
    } else if (e.key === 'Escape') {
        // Fermer le modal avec Escape
        prixModal.hide();
        e.preventDefault();
    } else if (e.key === 'Enter') {
        // Simuler un clic sur le bouton Sauvegarder avec Enter
        document.getElementById('savePrixBtn').click();
        e.preventDefault();
    }
}
</script>

<!-- Modale pour la modification du prix -->
<div class="modal fade" id="prixModal" tabindex="-1" aria-labelledby="prixModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prixModalLabel">Modifier le prix</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <div class="price-display mb-4">
                    <div id="prixDisplay" class="text-center display-4 fw-bold">0 €</div>
                </div>
                
                <div id="custom-keyboard" class="custom-numpad">
                    <div class="numpad-row">
                        <button type="button" class="numpad-key" data-value="1">1</button>
                        <button type="button" class="numpad-key" data-value="2">2</button>
                        <button type="button" class="numpad-key" data-value="3">3</button>
                    </div>
                    <div class="numpad-row">
                        <button type="button" class="numpad-key" data-value="4">4</button>
                        <button type="button" class="numpad-key" data-value="5">5</button>
                        <button type="button" class="numpad-key" data-value="6">6</button>
                    </div>
                    <div class="numpad-row">
                        <button type="button" class="numpad-key" data-value="7">7</button>
                        <button type="button" class="numpad-key" data-value="8">8</button>
                        <button type="button" class="numpad-key" data-value="9">9</button>
                    </div>
                    <div class="numpad-row">
                        <button type="button" class="numpad-key" data-value="C">
                            <i class="fas fa-times"></i>
                        </button>
                        <button type="button" class="numpad-key" data-value="0">0</button>
                        <button type="button" class="numpad-key" data-value=".">
                            <i class="fas fa-dot-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="savePrixBtn">Sauvegarder</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour ajouter une photo -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white border-bottom-0">
                <h5 class="modal-title" id="cameraModalLabel">
                    <i class="fas fa-camera me-2"></i>Prendre une photo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <form id="cameraForm">
                    <input type="hidden" name="reparation_id" value="<?php echo $reparation_id; ?>">
                    
                    <!-- Zone caméra -->
                    <div id="cameraContainer" class="text-center mb-3">
                        <video id="camera" autoplay playsinline class="img-fluid rounded" style="max-height: 400px;"></video>
                        <canvas id="cameraCanvas" class="d-none"></canvas>
                    </div>

                    <!-- Zone de prévisualisation -->
                    <div id="photoPreview" class="text-center mb-3 d-none">
                        <div class="position-relative d-inline-block">
                            <img id="previewImage" src="" alt="Aperçu" class="img-fluid rounded" style="max-height: 400px;">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2" id="retakePhoto">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label for="photoDescription" class="form-label">Description (optionnelle)</label>
                        <textarea class="form-control" id="photoDescription" name="description" rows="2" placeholder="Décrivez ce que montre la photo..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Annuler
                </button>
                <button type="button" class="btn btn-primary" id="captureBtn">
                    <i class="fas fa-camera me-2"></i> Capturer
                </button>
                <button type="button" class="btn btn-success d-none" id="savePhotoBtn">
                    <i class="fas fa-save me-2"></i> Sauvegarder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour afficher toutes les photos -->
<div class="modal fade" id="photosModal" tabindex="-1" aria-labelledby="photosModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="photosModalLabel">
                    <i class="fas fa-images me-2"></i>Photos de la réparation #<?php echo $reparation_id; ?>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Bouton pour ajouter une nouvelle photo -->
                <div class="d-flex justify-content-end mb-3">
                    <button type="button" class="btn btn-primary" id="btn-ajouter-photo">
                        <i class="fas fa-camera me-2"></i>Ajouter une photo
                    </button>
                </div>

                <?php if (empty($photos)): ?>
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-camera-retro fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted">Aucune photo disponible</h4>
                    <p class="text-muted">Cliquez sur "Ajouter une photo" pour commencer à documenter cette réparation.</p>
                </div>
                <?php else: ?>
                <!-- Grille des photos -->
                <div class="photo-grid">
                    <?php foreach ($photos as $photo): ?>
                    <div class="photo-item" data-id="<?php echo $photo['id']; ?>" data-url="<?php echo $photo['url']; ?>">
                        <div class="photo-wrapper">
                            <img src="<?php echo $photo['url']; ?>" alt="Photo de réparation" class="img-fluid">
                            <div class="photo-overlay">
                                <div class="photo-actions">
                                    <button type="button" class="btn btn-sm btn-light me-1 view-photo-btn" data-url="<?php echo $photo['url']; ?>">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger delete-photo-btn" data-id="<?php echo $photo['id']; ?>">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                <?php if (!empty($photo['description'])): ?>
                                <div class="photo-description">
                                    <?php echo htmlspecialchars($photo['description']); ?>
                                </div>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                    <?php endforeach; ?>
                </div>
                <?php endif; ?>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour voir une photo en grand -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1" aria-labelledby="viewPhotoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="viewPhotoModalLabel">Photo en détail</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                <div class="photo-view-container">
                    <img id="fullsizePhoto" src="" alt="Photo agrandie" class="img-fluid">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale pour terminer la réparation -->
<div class="modal fade" id="terminerModal" tabindex="-1" aria-labelledby="terminerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="terminerModalLabel">Terminer la réparation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3 fw-bold">Veuillez choisir le nouveau statut de la réparation :</p>
                
                <div class="statut-options">
                    <?php
                    // Récupérer les statuts possibles pour la fin d'une réparation
                    $statuts_fin = [];
                    try {
                        $stmt = $pdo->query("
                            SELECT s.id, s.code, s.nom, sc.couleur 
                            FROM statuts s 
                            JOIN statut_categories sc ON s.categorie_id = sc.id 
                            WHERE sc.id IN (2, 4) AND s.est_actif = 1
                            ORDER BY s.ordre ASC
                        ");
                        $statuts_fin = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    } catch (PDOException $e) {
                        // En cas d'erreur, utiliser des statuts par défaut
                        $statuts_fin = [
                            ['id' => 9, 'code' => 'reparation_effectue', 'nom' => 'Réparation effectuée', 'couleur' => '28a745'],
                            ['id' => 10, 'code' => 'reparation_annule', 'nom' => 'Réparation annulée', 'couleur' => 'dc3545'],
                            ['id' => 6, 'code' => 'en_attente_accord_client', 'nom' => "En attente de l'accord client", 'couleur' => 'ffc107']
                        ];
                    }
                    
                    foreach ($statuts_fin as $statut):
                    ?>
                    <div class="statut-option mb-3">
                        <input class="form-check-input visually-hidden" type="radio" name="nouveau_statut" 
                               id="statut_<?php echo $statut['code']; ?>" 
                               value="<?php echo $statut['code']; ?>"
                               data-statut-id="<?php echo $statut['id']; ?>">
                        <label class="status-option-label d-block w-100" for="statut_<?php echo $statut['code']; ?>">
                            <div class="d-flex align-items-center w-100 p-3 rounded status-option-content" 
                                 style="border: 2px solid #<?php echo $statut['couleur']; ?>; 
                                        background-color: rgba(<?php echo hexToRgb($statut['couleur']); ?>, 0.1);">
                                <div class="status-icon me-3" style="background-color: #<?php echo $statut['couleur']; ?>;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <span class="fw-bold status-name">
                                    <?php echo htmlspecialchars($statut['nom']); ?>
                                </span>
                            </div>
                        </label>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <!-- Ajouter l'attribut onclick directement sur le bouton -->
                <button type="button" class="btn btn-primary" id="confirmerTerminer" onclick="confirmerTerminerClick()">Confirmer</button>
                <!-- Bouton alternatif de formulaire -->
                <form id="terminerForm" method="post" action="ajax/manual_terminer.php">
                    <input type="hidden" name="reparation_id" value="<?php echo $reparation_id; ?>">
                    <input type="hidden" name="nouveau_statut" id="terminerFormStatut" value="">
                    <button type="button" class="btn btn-warning" onclick="submitTerminerForm()">Confirmer (Alt)</button>
                </form>
                <!-- Bouton de test pour déboguer -->
                <button type="button" class="btn btn-info" id="testButton" onclick="testButtonClick()">Test</button>
            </div>
        </div>
    </div>
</div> 

<!-- Modale pour modifier les notes techniques -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notesModalLabel">Notes techniques</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <form method="POST" action="index.php?page=statut_rapide&id=<?php echo $reparation_id; ?>">
                <div class="modal-body">
                    <input type="hidden" name="action" value="update_notes">
                    <div class="mb-3">
                        <label for="notes_techniques" class="form-label">Notes internes (visibles uniquement par les techniciens) :</label>
                        <textarea class="form-control" id="notes_techniques" name="notes_techniques" rows="5"><?php echo html_entity_decode($reparation['notes_techniques'] ?? ''); ?></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-info" id="viewHistoryBtn">Voir historique</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ajouter Commande -->
<div class="modal fade" id="ajouterCommandeModal" tabindex="-1" aria-labelledby="ajouterCommandeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-bottom-0 rounded-top-4">
                <h5 class="modal-title" id="ajouterCommandeModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Nouvelle commande de pièces
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="ajouterCommandeForm" method="post" action="ajax/add_commande.php">
                    <div class="row g-4">
                        <!-- Sélection du client -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Client</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-primary" type="button" id="searchClientBtn" data-bs-toggle="modal" data-bs-target="#rechercheClientModal">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <input type="text" id="nom_client_selectionne" class="form-control border-0 shadow-sm" value="" placeholder="Saisir ou rechercher un client...">
                                    <input type="hidden" name="client_id" id="client_id" value="">
                                </div>
                                <div id="client_selectionne" class="selected-item-info d-none mt-2">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-icon me-2">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <span class="fw-medium nom_client"></span>
                                            <span class="d-block small text-muted tel_client"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Résultats de recherche client inline -->
                                <div id="resultats_recherche_client_inline" class="mt-2 d-none">
                                    <div class="card border-0 shadow-sm">
                                        <div class="list-group list-group-flush" id="liste_clients_recherche_inline">
                                            <!-- Les résultats seront ajoutés ici -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sélection de la réparation liée -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Réparation liée (optionnel)</label>
                                <select class="form-select form-select-lg border-0 shadow-sm rounded-3" name="reparation_id" id="reparation_id" onchange="getClientFromReparation(this.value)">
                                    <option value="">Sélectionner une réparation...</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Informations de la première pièce -->
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Fournisseur</label>
                                <select class="form-select form-select-lg border-0 shadow-sm rounded-3" name="fournisseur_id" id="fournisseur_id_ajout" required>
                                    <option value="">Sélectionner un fournisseur</option>
                                    <?php
                                    try {
                                        $stmt = $pdo->query("SELECT id, nom FROM fournisseurs ORDER BY nom");
                                        while ($fournisseur = $stmt->fetch()) {
                                            echo "<option value='{$fournisseur['id']}'>" . 
                                                 htmlspecialchars($fournisseur['nom']) . "</option>";
                                        }
                                    } catch (PDOException $e) {
                                        echo "<option value=''>Erreur de chargement des fournisseurs</option>";
                                    }
                                    ?>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Pièce commandée</label>
                                <input type="text" class="form-control form-control-lg border-0 shadow-sm rounded-3" name="nom_piece" id="nom_piece" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Code barre</label>
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-lg border-0 shadow-sm rounded-start-3" name="code_barre" id="code_barre" placeholder="Saisir le code barre">
                                    <button type="button" class="btn btn-outline-primary btn-lg rounded-end-3 scan-code-btn">
                                        <i class="fas fa-barcode"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Quantité</label>
                                <div class="input-group">
                                    <button type="button" class="btn btn-outline-primary btn-lg rounded-start-3 decrement-btn">-</button>
                                    <input type="number" class="form-control form-control-lg text-center border-0 shadow-sm quantite-input" name="quantite" id="quantite" min="1" value="1" required>
                                    <button type="button" class="btn btn-outline-primary btn-lg rounded-end-3 increment-btn">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Prix estimé (€)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control form-control-lg border-0 shadow-sm rounded-start-3" name="prix_estime" id="prix_estime" step="0.01" required>
                                    <span class="input-group-text bg-light rounded-end-3 border-0 shadow-sm">€</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-medium">Statut</label>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-warning flex-grow-1 status-btn active rounded-3" data-status="en_attente">
                                        <i class="fas fa-clock me-1"></i> En attente
                                    </button>
                                    <button type="button" class="btn btn-outline-primary flex-grow-1 status-btn rounded-3" data-status="commande">
                                        <i class="fas fa-shopping-cart fa-lg"></i> Commandé
                                    </button>
                                    <button type="button" class="btn btn-outline-success flex-grow-1 status-btn rounded-3" data-status="recue">
                                        <i class="fas fa-box fa-lg"></i> Reçu
                                    </button>
                                </div>
                                <input type="hidden" name="statut" id="statut_input" value="en_attente">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container pour les pièces additionnelles -->
                    <div id="pieces-additionnelles"></div>
                    
                    <!-- Bouton pour ajouter une pièce supplémentaire -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-outline-primary btn-lg rounded-pill" id="ajouter-piece-btn">
                            <i class="fas fa-plus-circle me-2"></i>Ajouter une autre pièce
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="submit" form="ajouterCommandeForm" class="btn btn-primary" id="saveCommandeBtn">
                    <i class="fas fa-save me-2"></i>Enregistrer la commande
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Script supplémentaire pour le modal de commande
document.addEventListener('DOMContentLoaded', function() {
    // Gestionnaire d'événements pour les boutons de statut du modal
    document.querySelectorAll('#ajouterCommandeModal .status-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Désélectionner tous les boutons
            document.querySelectorAll('#ajouterCommandeModal .status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Sélectionner le bouton cliqué
            this.classList.add('active');
            
            // Mettre à jour la valeur cachée
            const status = this.getAttribute('data-status');
            document.querySelector('#statut_input').value = status;
        });
    });
    
    // Gestion des boutons +/- pour la quantité
    const setupQuantityButtons = function() {
        // Boutons de diminution
        document.querySelectorAll('.decrement-btn').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.nextElementSibling;
                let value = parseInt(input.value);
                if (value > 1) {
                    input.value = value - 1;
                }
            });
        });
        
        // Boutons d'augmentation
        document.querySelectorAll('.increment-btn').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                let value = parseInt(input.value);
                input.value = value + 1;
            });
        });
    };
    
    // Initialiser les boutons de quantité
    setupQuantityButtons();
    
    // Fonction pour charger la réparation en cours
    function chargerReparationEnCours() {
        const reparationId = <?php echo $reparation_id; ?>;
        const clientId = <?php echo $reparation['client_id']; ?>;
        
        // Préremplir le champ client et réparation
        document.getElementById('client_id').value = clientId;
        document.getElementById('nom_client_selectionne').value = '<?php echo htmlspecialchars($reparation['client_nom'] . ' ' . $reparation['client_prenom']); ?>';
        
        // Afficher le client sélectionné
        const clientSelectionne = document.getElementById('client_selectionne');
        if (clientSelectionne) {
            clientSelectionne.classList.remove('d-none');
            const nomClientElement = clientSelectionne.querySelector('.nom_client');
            if (nomClientElement) {
                nomClientElement.textContent = '<?php echo htmlspecialchars($reparation['client_nom'] . ' ' . $reparation['client_prenom']); ?>';
            }
            
            const telClientElement = clientSelectionne.querySelector('.tel_client');
            if (telClientElement) {
                telClientElement.textContent = '<?php echo htmlspecialchars($reparation['client_telephone']); ?>';
            }
        }
        
        // Charger les réparations du client pour permettre de choisir
        chargerReparationsClient(clientId);
    }
    
    // Lorsque le modal s'ouvre, charger la réparation en cours
    document.querySelector('#ajouterCommandeModal').addEventListener('shown.bs.modal', function() {
        chargerReparationEnCours();
    });
    
    // Fonction pour récupérer le client à partir de la réparation sélectionnée
    window.getClientFromReparation = function(reparationId) {
        if (!reparationId) return;
        
        fetch(`ajax/get_reparation_client.php?reparation_id=${reparationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.client) {
                    // Mettre à jour le client sélectionné
                    document.getElementById('client_id').value = data.client.id;
                    document.getElementById('nom_client_selectionne').value = `${data.client.nom} ${data.client.prenom}`;
                    
                    // Afficher le client sélectionné
                    const clientSelectionne = document.getElementById('client_selectionne');
                    if (clientSelectionne) {
                        clientSelectionne.classList.remove('d-none');
                        const nomClientElement = clientSelectionne.querySelector('.nom_client');
                        if (nomClientElement) {
                            nomClientElement.textContent = `${data.client.nom} ${data.client.prenom}`;
                        }
                        
                        const telClientElement = clientSelectionne.querySelector('.tel_client');
                        if (telClientElement) {
                            telClientElement.textContent = data.client.telephone;
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Erreur lors de la récupération du client:', error);
            });
    };
});
</script>

<!-- Modale pour la confirmation de l'envoi du devis -->
<div class="modal fade" id="devisModal" tabindex="-1" aria-labelledby="devisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="devisModalLabel">Confirmation du devis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p>Vous allez envoyer un devis au client pour la réparation de son appareil.</p>
                <div class="mb-3">
                    <label for="devis-montant" class="form-label">Montant du devis :</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="devis-montant" name="devis-montant" step="0.01" 
                               value="<?php echo !empty($reparation['prix_reparation']) ? $reparation['prix_reparation'] : ''; ?>" required>
                        <span class="input-group-text">€</span>
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="devis-update-prix" name="devis-update-prix" checked>
                    <label class="form-check-label" for="devis-update-prix">
                        Mettre à jour le prix de la réparation
                    </label>
                </div>
                <div class="alert alert-info">
                    <small>Un SMS sera envoyé au client (<?php echo htmlspecialchars($reparation['client_telephone']); ?>) et le statut de la réparation passera à "En attente de l'accord client".</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" id="confirmer-devis-btn" class="btn btn-primary">Envoyer le devis</button>
            </div>
        </div>
    </div>
</div>

<!-- Modale pour la confirmation du gardiennage -->
<div class="modal fade" id="gardiennageModal" tabindex="-1" aria-labelledby="gardiennageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gardiennageModalLabel">Confirmation du gardiennage</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <p>Vous allez placer l'appareil en gardiennage. Un SMS sera envoyé au client pour l'informer des frais de gardiennage.</p>
                <div class="mb-3">
                    <label for="gardiennage-notes" class="form-label">Notes (optionnel) :</label>
                    <textarea class="form-control" id="gardiennage-notes" name="gardiennage-notes" rows="3"></textarea>
                </div>
                <div class="alert alert-info">
                    <small>Un SMS sera envoyé au client (<?php echo htmlspecialchars($reparation['client_telephone']); ?>) et le statut de la réparation passera à "Gardiennage".</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" id="confirmer-gardiennage-btn" class="btn btn-primary">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour envoyer un SMS -->
<div class="modal fade" id="smsModal" tabindex="-1" aria-labelledby="smsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient-primary text-white border-0">
                <h5 class="modal-title" id="smsModalLabel">
                    <i class="fas fa-sms me-2"></i>Envoyer un SMS
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="client-info-sms mb-3 p-3 rounded bg-light">
                    <div class="d-flex align-items-center">
                        <div class="client-avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h6 class="mb-0" id="client-name-display">Nom du client</h6>
                            <p class="mb-0 text-muted" id="client-phone-display">Téléphone</p>
                        </div>
                    </div>
                </div>

                <form id="smsForm">
                    <input type="hidden" id="sms-client-id" name="client_id" value="">
                    <input type="hidden" id="sms-reparation-id" name="reparation_id" value="<?php echo $reparation_id; ?>">
                    
                    <div class="sms-options mb-4">
                        <div class="option-title mb-3">
                            <h6 class="text-uppercase small fw-bold text-muted">Type de message</h6>
                            <div class="progress" style="height: 1px">
                                <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-center gap-3">
                            <div class="sms-option-card predefini" data-type="predefini">
                                <div class="icon-circle bg-primary-light mb-2">
                                    <i class="fas fa-comment-dots text-primary"></i>
                                </div>
                                <h6 class="option-text">Message prédéfini</h6>
                            </div>
                            
                            <div class="sms-option-card personnalise" data-type="personnalise">
                                <div class="icon-circle bg-secondary-light mb-2">
                                    <i class="fas fa-edit text-secondary"></i>
                                </div>
                                <h6 class="option-text">Message personnalisé</h6>
                            </div>
                        </div>
                    </div>
                    
                    <div id="message-content-container" class="d-none">
                        <!-- Templates prédéfinis -->
                        <div id="predefined-templates" class="message-option-content d-none">
                            <div class="option-title mb-3">
                                <h6 class="text-uppercase small fw-bold text-muted">Modèles disponibles</h6>
                                <div class="progress" style="height: 1px">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="templates-container">
                                <?php
                                // Récupérer les modèles de SMS depuis la base de données
                                try {
                                    $stmt = $pdo->query("
                                        SELECT id, nom, contenu
                                        FROM sms_templates 
                                        WHERE est_actif = 1
                                        ORDER BY nom ASC
                                    ");
                                    $templates = $stmt->fetchAll(PDO::FETCH_ASSOC);
                                    
                                    if (empty($templates)) {
                                        echo '<div class="alert alert-info">Aucun modèle de SMS disponible.</div>';
                                    } else {
                                        foreach ($templates as $index => $template) {
                                            $activeClass = $index === 0 ? 'active' : '';
                                            echo '<div class="template-card ' . $activeClass . '" data-id="' . $template['id'] . '">';
                                            echo '<div class="template-header">';
                                            echo '<div class="template-name">' . htmlspecialchars($template['nom']) . '</div>';
                                            echo '<div class="template-check"><i class="fas fa-check-circle"></i></div>';
                                            echo '</div>';
                                            echo '<div class="template-content">' . htmlspecialchars($template['contenu']) . '</div>';
                                            echo '</div>';
                                        }
                                    }
                                } catch (PDOException $e) {
                                    echo '<div class="alert alert-danger">Erreur lors du chargement des modèles de SMS.</div>';
                                    error_log("Erreur lors du chargement des modèles de SMS: " . $e->getMessage());
                                }
                                ?>
                            </div>
                        </div>
                        
                        <!-- Message personnalisé -->
                        <div id="custom-message" class="message-option-content d-none">
                            <div class="option-title mb-3">
                                <h6 class="text-uppercase small fw-bold text-muted">Votre message</h6>
                                <div class="progress" style="height: 1px">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="form-floating">
                                <textarea class="form-control" id="sms-message" name="message" style="height: 120px"></textarea>
                                <label for="sms-message">Saisissez votre message</label>
                            </div>
                            
                            <div class="text-end mt-2">
                                <small class="text-muted"><span id="sms-char-count">0</span>/160 caractères</small>
                            </div>
                        </div>
                        
                        <!-- Variables disponibles -->
                        <div id="variables-section">
                            <div class="option-title mb-3">
                                <h6 class="text-uppercase small fw-bold text-muted">Variables disponibles</h6>
                                <div class="progress" style="height: 1px">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="variables-container mb-4">
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="variable-badge">[CLIENT_NOM]</span>
                                    <span class="variable-badge">[CLIENT_PRENOM]</span>
                                    <span class="variable-badge">[REPARATION_ID]</span>
                                    <span class="variable-badge">[APPAREIL_TYPE]</span>
                                    <span class="variable-badge">[APPAREIL_MODELE]</span>
                                    <span class="variable-badge">[PRIX]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary d-flex align-items-center" id="send-sms-btn" disabled>
                    <span class="spinner-border spinner-border-sm me-2 d-none" id="sms-spinner"></span>
                    <i class="fas fa-paper-plane me-2"></i>Envoyer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale pour terminer la réparation -->
</div>

<script>
// Attendre que le DOM soit complètement chargé
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM chargé, initialisation des composants futuristes...");
    
    // Cacher le préchargeur après le chargement complet
    setTimeout(function() {
        const preloader = document.getElementById('futuristic-preloader');
        if (preloader) {
            preloader.classList.add('loaded');
            
            // Supprimer complètement le préchargeur après l'animation de fondu
            setTimeout(function() {
                preloader.remove();
            }, 500);
        }
    }, 2500); // Attendre 2.5 secondes pour montrer l'animation complète du préchargeur
    
    // Ajout d'un effet de particules en arrière-plan
    createParticles();
    
    // Ajouter des délais d'animation pour les photos
    const photoItems = document.querySelectorAll('.photo-item');
    photoItems.forEach((item, index) => {
        item.style.setProperty('--animation-order', index);
    });
    
    // Animation des boutons d'action
    const finalBtns = document.querySelectorAll('.final-btn');
    finalBtns.forEach((btn, index) => {
        btn.style.animationDelay = `${index * 0.1}s`;
        
        // Ajouter un effet de pulsation au survol
        btn.addEventListener('mouseenter', function() {
            this.classList.add('btn-pulse');
        });
        
        btn.addEventListener('mouseleave', function() {
            this.classList.remove('btn-pulse');
        });
    });
    
    // Effet holographique sur les badges de statut
    const statusBadges = document.querySelectorAll('.status-badge .badge');
    statusBadges.forEach(badge => {
        badge.innerHTML = `<span class="badge-content">${badge.innerHTML}</span>`;
        badge.innerHTML += '<span class="holographic-effect"></span>';
    });
    
    // Amélioration du feedback tactile sur mobile
    const allButtons = document.querySelectorAll('button, .btn, .final-btn');
    allButtons.forEach(btn => {
        btn.addEventListener('touchstart', function() {
            this.classList.add('touch-active');
        });
        
        btn.addEventListener('touchend', function() {
            this.classList.remove('touch-active');
            setTimeout(() => {
                this.classList.add('touch-ripple');
                setTimeout(() => {
                    this.classList.remove('touch-ripple');
                }, 400);
            }, 10);
        });
    });
    
    // Détection du mode sombre du système
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark-mode');
    }
    
    // Écouteur pour les changements de mode sombre/clair du système
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (event.matches) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    });
    
    // Fonction pour créer les particules en arrière-plan
    function createParticles() {
        const mainContent = document.querySelector('.main-content');
        if (!mainContent) return;
        
        // Créer un conteneur pour les particules
        const particlesContainer = document.createElement('div');
        particlesContainer.className = 'particles-container';
        mainContent.appendChild(particlesContainer);
        
        // Ajouter des particules
        for (let i = 0; i < 15; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            
            // Taille aléatoire
            const size = Math.random() * 8 + 2;
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            
            // Position aléatoire
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            
            // Opacité aléatoire
            particle.style.opacity = Math.random() * 0.5 + 0.1;
            
            // Animation aléatoire
            const animDuration = Math.random() * 15 + 5;
            particle.style.animation = `floatParticle ${animDuration}s linear infinite`;
            particle.style.animationDelay = `${Math.random() * 5}s`;
            
            particlesContainer.appendChild(particle);
        }
        
        // Ajouter un style pour les particules
        const style = document.createElement('style');
        style.textContent = `
            .particles-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                pointer-events: none;
                z-index: 0;
            }
            
            .particle {
                position: absolute;
                background-color: rgba(30, 144, 255, 0.4);
                border-radius: 50%;
                filter: blur(1px);
                z-index: 0;
            }
            
            @keyframes floatParticle {
                0% {
                    transform: translateY(0) translateX(0);
                }
                25% {
                    transform: translateY(-30px) translateX(10px);
                }
                50% {
                    transform: translateY(-15px) translateX(-15px);
                }
                75% {
                    transform: translateY(10px) translateX(15px);
                }
                100% {
                    transform: translateY(0) translateX(0);
                }
            }
            
            .dark-mode .particle {
                background-color: rgba(60, 160, 255, 0.5);
            }
            
            .btn-pulse {
                animation: btnPulse 0.8s infinite alternate !important;
            }
            
            @keyframes btnPulse {
                0% {
                    transform: scale(1);
                    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
                }
                100% {
                    transform: scale(1.05);
                    box-shadow: 0 12px 24px rgba(30, 144, 255, 0.5);
                }
            }
            
            .touch-active {
                transform: scale(0.95) !important;
                transition: transform 0.1s !important;
            }
            
            .touch-ripple {
                position: relative;
                overflow: hidden;
            }
            
            .touch-ripple::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 5px;
                height: 5px;
                background: rgba(255, 255, 255, 0.5);
                opacity: 0;
                border-radius: 100%;
                transform: scale(1, 1) translate(-50%, -50%);
                transform-origin: 50% 50%;
                animation: ripple 0.4s ease-out;
            }
            
            @keyframes ripple {
                0% {
                    transform: scale(0, 0) translate(-50%, -50%);
                    opacity: 0.5;
                }
                100% {
                    transform: scale(20, 20) translate(-50%, -50%);
                    opacity: 0;
                }
            }
            
            .holographic-effect {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(
                    45deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.1) 50%,
                    rgba(255, 255, 255, 0) 100%
                );
                pointer-events: none;
                animation: holographicScan 2s linear infinite;
            }
            
            @keyframes holographicScan {
                0% {
                    transform: translateX(-100%) rotate(45deg);
                }
                100% {
                    transform: translateX(100%) rotate(45deg);
                }
            }
            
            .badge-content {
                position: relative;
                z-index: 1;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Amélioration visuelle pour la section des notes techniques
    const notesText = document.querySelector('.notes-text');
    if (notesText) {
        notesText.addEventListener('click', function() {
            // Effet de clic visuel
            this.style.textShadow = '0 0 10px var(--accent-glow)';
            setTimeout(() => {
                this.style.textShadow = '';
            }, 300);
        });
    }
    
    // Effet de traitement pour les boutons
    function addProcessingEffect(button, successCallback) {
        button.addEventListener('click', function() {
            // Ajout de la classe d'animation
            this.classList.add('processing');
            
            // Ajout d'un élément d'animation
            const processingElement = document.createElement('div');
            processingElement.className = 'processing-effect';
            this.appendChild(processingElement);
            
            // Définir un délai pour simuler le traitement
            setTimeout(() => {
                // Retirer l'animation de traitement
                this.classList.remove('processing');
                processingElement.remove();
                
                // Exécuter le callback de succès si fourni
                if (typeof successCallback === 'function') {
                    successCallback();
                }
            }, 1000);
        });
    }
    
    // Appliquer l'effet de traitement aux boutons principaux
    document.querySelectorAll('.final-btn').forEach(btn => {
        addProcessingEffect(btn);
    });
    
    // Détection du type d'appareil pour adapter l'interface
    function detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        const mobileInterface = document.querySelector('.mobile-interface');
        
        if (!mobileInterface) return;
        
        if (/iphone|ipad|ipod/.test(userAgent)) {
            mobileInterface.classList.add('ios-device');
        } else if (/android/.test(userAgent)) {
            mobileInterface.classList.add('android-device');
        }
    }
    
    detectDevice();
});
</script>

</body>
</html>
